(self.webpackChunkh4g_limo=self.webpackChunkh4g_limo||[]).push([[1777],{53637:(e,t,i)=>{"use strict";i.d(t,{ZP:()=>l});var s=i(86347),r=i(2747),n=i(69141),a=i(18419),o=i(24937),h=i(90129);class l{constructor(e=200){this.duration=e,this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this._effect="",this._effects=[],this._scale=0}get effect(){return this._effect}set effect(e){if(this._effect===(e=e||""))return;this._effect=e;const t=function(e){if(!e)return[];if("string"==typeof e){const t=(0,h.Q)(e);return t.error?t.error:[{scale:-1,effects:t.effects}]}const t=[];for(const i of e){if(!isFinite(i.scale)||i.scale<=0)return new r.Z("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});const e=(0,h.Q)(i.value);if(e.error)return e.error;t.push({scale:i.scale,effects:e.effects})}t.sort((e,t)=>t.effects.length-e.effects.length);for(let i=0;i<t.length-1;i++){if(!u(t[i].effects,t[i+1].effects))return new r.Z("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[i].effects,b:t[i+1].effects});c(t[i].effects,t[i+1].effects)}return t.sort((e,t)=>t.scale-e.scale),t}(e);Array.isArray(t)?this._transitionTo(t):(this._transitionTo([]),a.Z.getLogger("esri.views.layers.effects.EffectList").warn("Invalid Effect",{effect:e,error:t}))}get hasEffects(){return this.transitioning||!!this._effects.length}get effects(){return this._effects}get scale(){return this._scale}get transitioning(){return null!==this._to}transitionStep(e,t){this._applyTimeTransition(e),this._updateForScale(t)}_transitionTo(e){this.scale>0&&function(e,t,i){var s,r,n,a;return null==(s=e[0])||!s.effects||null==(r=t[0])||!r.effects||!((-1===(null==(n=e[0])?void 0:n.scale)||-1===(null==(a=t[0])?void 0:a.scale))&&(e.length>1||t.length>1)&&i<=0)&&u(e[0].effects,t[0].effects)}(this._current,e,this.scale)?(this._final=e,this._to=(0,n.d9)(e),function(e,t,i){var s,r;const n=e.length>t.length?e:t,a=e.length>t.length?t:e,o=a[a.length-1],h=null!=(s=null==o?void 0:o.scale)?s:i,l=null!=(r=null==o?void 0:o.effects)?r:[];for(let d=a.length;d<n.length;d++)a.push({scale:h,effects:[...l]});for(let d=0;d<n.length;d++)a[d].scale=-1===a[d].scale?i:a[d].scale,n[d].scale=-1===n[d].scale?i:n[d].scale,c(a[d].effects,n[d].effects)}(this._current,this._to,this.scale),this._from=(0,n.d9)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._effects=this._current[0]?(0,n.d9)(this._current[0].effects):[]}_applyTimeTransition(e){if(!this._to)return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let i=0;i<this._current.length;i++){const e=this._current[i],s=this._from[i],r=this._to[i];e.scale=p(s.scale,r.scale,t);for(let i=0;i<e.effects.length;i++)e.effects[i].interpolate(s.effects[i],r.effects[i],t)}1===t&&(this._current=this._final,this._effects=this._current[0]?(0,n.d9)(this._current[0].effects):[],this._from=this._to=this._final=null)}_updateForScale(e){if(0===this._current.length)return;this._scale=e;const t=this._current,i=this._current.length-1;let s,r,n=1;if(1===t.length||e>=t[0].scale)r=s=t[0].effects;else if(e<=t[i].scale)r=s=t[i].effects;else for(let a=0;a<i;a++){const i=t[a],o=t[a+1];if(i.scale>=e&&o.scale<=e){n=(e-i.scale)/(o.scale-i.scale),s=i.effects,r=o.effects;break}}for(let a=0;a<this._effects.length;a++)this._effects[a].interpolate(s[a],r[a],n)}}function d(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new o.GI(e.type,0);case"saturate":case"brightness":case"contrast":return new o.GI(e.type,1);case"opacity":return new o.Zx(1);case"hue-rotate":return new o.Tq(0);case"blur":return new o.Tj(0);case"drop-shadow":return new o.CE(0,0,0,[...(0,s.h$)("transparent")]);case"bloom":return new o.rk(0,0,0)}}function u(e,t){const i=e.length>t.length?e:t;return(e.length>t.length?t:e).every((e,t)=>e.type===i[t].type)}function c(e,t){const i=e.length>t.length?e:t,s=e.length>t.length?t:e;for(let r=s.length;r<i.length;r++)s.push(d(i[r]))}function p(e,t,i){return e+(t-e)*i}},8690:(e,t,i)=>{"use strict";i.d(t,{W:()=>h});var s=i(12131),r=i(45910),n=i(53637),a=i(66863);const o=(0,s.Z)("mapview-transitions-duration");class h extends a.s{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectList=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach(t=>t.clips=e)}get computedEffects(){var e,t;return null!=(e=null==(t=this._effectList)?void 0:t.effects)?e:null}get effect(){var e,t;return null!=(e=null==(t=this._effectList)?void 0:t.effect)?e:""}set effect(e){(this._effectList||e)&&(this._effectList||(this._effectList=new n.ZP(o)),this._effectList.effect=e,this.requestRender())}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._effectList&&(this._effectList.transitionStep(e,t),this._effectList.transitioning&&this.requestRender())}doRender(e){const t=this.createRenderParams(e);this.renderChildren(t)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,t=this.children.length){if(!e)return e;if(this.contains(e))return e;this._needsSort=!0;const i=e.parent;return i&&i!==this&&i.removeChild(e),t>=this.children.length?this.children.push(e):this.children.splice(t,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const t=this.children.splice(e,1)[0];return this._childrenSet.delete(t),this!==this.stage&&(t.clips=null),t.stage=null,t.parent=null,t}sortChildren(e){this._needsSort&&(this.children.sort(e),this._needsSort=!1)}_createTransforms(){return{dvs:(0,r.c)()}}onAttach(){super.onAttach();const e=this.stage;for(const t of this.children)t.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const t of this.children)t.beforeRender(e);for(const t of this.children)t.processRender(e);for(const t of this.children)t.afterRender(e)}createRenderParams(e){return{...e,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition}}}},66863:(e,t,i)=>{"use strict";i.d(t,{s:()=>h});var s=i(70222),r=i(12131),n=i(54704),a=i(98154);const o=1/(0,r.Z)("mapview-transitions-duration");class h extends s.Z{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return(0,n.Wi)(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,a.hh)(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,a.hh)(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;null==(e=this.parent)||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.onDetach(),this.emit("detach")}updateTransitionProperties(e,t){if(this.fadeTransitionEnabled){const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const s=e*o;this.computedOpacity=i>t?Math.max(t,i-s):Math.min(t,i+s),this.computedVisible=this.computedOpacity>0;const r=t===this.computedOpacity;this.inFadeTransition=!r,r||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},79243:(e,t,i)=>{"use strict";i.d(t,{dk:()=>p,Gq:()=>g,a:()=>f,mE:()=>m,m2:()=>h,qr:()=>_,jj:()=>a,hF:()=>o});var s=i(2747),r=i(63054),n=i(90190);function a(e,t,i,s,n){switch(e){case r.LW.FILL:return p.from(t,s);case r.LW.LINE:return f.from(t,i);case r.LW.MARKER:return m.from(t);case r.LW.TEXT:return _.from(t);case r.LW.LABEL:return g.from(t,n);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${e}`)}}function o(e){switch(h.load(e).geometryType){case r.LW.MARKER:return new m(e);case r.LW.FILL:return new p(e);case r.LW.LINE:return new f(e);case r.LW.TEXT:return new _(e);case r.LW.LABEL:return new g(e)}}class h{constructor(e){this._data=0,this._data=e}static load(e){const t=this.shared;return t.data=e,t}set data(e){this._data=e}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(e){this.setBits(e,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(e){this.setBit(20,e)}get sdf(){return!!this.bit(11)}set sdf(e){this.setBit(11,e)}get pattern(){return!!this.bit(12)}set pattern(e){this.setBit(12,e)}get textureBinding(){return this.bits(0,8)}set textureBinding(e){this.setBits(e,0,8)}get geometryTypeString(){switch(this.geometryType){case r.LW.FILL:return"fill";case r.LW.MARKER:return"marker";case r.LW.LINE:return"line";case r.LW.TEXT:return"text";case r.LW.LABEL:return"label";default:throw new s.Z(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(e,t){const i=1<<e;t?this._data|=i:this._data&=~i}bit(e){return(this._data&1<<e)>>e}setBits(e,t,i){for(let s=t,r=0;s<i;s++,r++)this.setBit(s,0!=(e&1<<r))}bits(e,t){let i=0;for(let s=e,r=0;s<t;s++,r++)i|=this.bit(s)<<r;return i}hasVV(){return!1}setVV(e,t){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf}}getVariationHash(){return this._data&~(7&this.textureBinding)}}h.shared=new h(0);const l=e=>class extends e{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(e){this.setBit(16,e)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(e){this.setBit(17,e)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(e){this.setBit(18,e)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(e){this.setBit(19,e)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(e,t){super.setVV(e,t);const i=function(e,t=!1){const i=r.X.SIZE_FIELD_STOPS|r.X.SIZE_MINMAX_VALUE|r.X.SIZE_SCALE_STOPS|r.X.SIZE_UNIT_VALUE,s=(e&(r.mf.FIELD_TARGETS_OUTLINE|r.mf.MINMAX_TARGETS_OUTLINE|r.mf.SCALE_TARGETS_OUTLINE|r.mf.UNIT_TARGETS_OUTLINE))>>>4;return t?i&s:i&~s}(e,t)&e;this.vvSizeMinMaxValue=!!(i&r.X.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(i&r.X.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(i&r.X.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(i&r.X.SIZE_SCALE_STOPS)}},d=e=>class extends e{get vvRotation(){return 0!==this.bit(15)}set vvRotation(e){this.setBit(15,e)}hasVV(){return super.hasVV()||this.vvRotation}setVV(e,t){super.setVV(e,t),this.vvRotation=!t&&!!(e&r.X.ROTATION)}},u=e=>class extends e{get vvColor(){return 0!==this.bit(13)}set vvColor(e){this.setBit(13,e)}hasVV(){return super.hasVV()||this.vvColor}setVV(e,t){super.setVV(e,t),this.vvColor=!t&&!!(e&r.X.COLOR)}},c=e=>class extends e{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(e){this.setBit(14,e)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(e,t){super.setVV(e,t),this.vvOpacity=!t&&!!(e&r.X.OPACITY)}};class p extends(u(c(h))){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=r.LW.FILL,t?i.dotDensity=!0:i.setVV(e,!1),i.data}getVariation(){return{...super.getVariation(),dotDensity:this.dotDensity,vvColor:this.vvColor,vvOpacity:this.vvOpacity}}get dotDensity(){return!!this.bit(15)}set dotDensity(e){this.setBit(15,e)}}p.shared=new p(0);class m extends(u(c(d(l(h))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=r.LW.MARKER,t.setVV(e,!1),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}m.shared=new m(0);class f extends(u(c(l(h)))){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=r.LW.LINE,i.setVV(e,t),i.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}f.shared=new f(0);class _ extends(u(c(d(l(h))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(e);return t.geometryType=r.LW.TEXT,t.setVV(e,!1),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}_.shared=new _(0);class g extends(l(h)){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=r.LW.LABEL,i.setVV(e,!1),i.mapAligned=(0,n.N)(t),i.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}g.shared=new g(0)},90190:(e,t,i)=>{"use strict";function s(e){switch(e){case"above-along":case"below-along":case"center-along":case"esriServerLinePlacementAboveAlong":case"esriServerLinePlacementBelowAlong":case"esriServerLinePlacementCenterAlong":return!0;default:return!1}}i.d(t,{N:()=>s})},48417:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GraphicContainer:()=>yi.Z,GraphicsView2D:()=>vi.Z,LabelManager:()=>gi,MagnifierView2D:()=>es,MapViewNavigation:()=>ji,Stage:()=>Kt});var s=i(16304),r=i(2747),n=i(43339),a=i(12131),o=i(54704),h=i(47915),l=i(72147),d=i(76620),u=i(44596),c=i(44435),p=i(45910),m=i(49882),f=i(98737),_=i(98248),g=i(8485),v=(i(6532),i(86712),i(17757),i(82384)),y=i(96900),b=i(28989),w=i(13811),x=i(66899),T=i(8690),S=i(6843);function C(e){if(!e)return null;const t=e.inverseTransform,i=e.transform,s=e.transformNoRotation,r=e.pixelRatio,n=[e.size[0],e.size[1]],a=e.viewpoint.targetGeometry,o=(0,f.f)(a.x,a.y);return{version:e.id,displayMat3:e.displayMat3.slice(),displayViewMat3:e.displayViewMat3.slice(),viewMat2d:e.viewMat2d.slice(),extent:e.extent.toJSON(),resolution:e.resolution,rotation:e.rotation,size:n,scale:e.scale,center:[a.x,a.y],spatialReference:e.spatialReference,pixelRatio:r,viewpoint:e.viewpoint,worldScreenWidth:e.worldScreenWidth,toMap:(e,i)=>(0,m.t)(e,i,t),toScreen:(e,t)=>(0,m.t)(e,t,i),toScreenNoRotation:(e,t)=>(0,m.t)(e,t,s),getScreenTransform:(e,t)=>((0,S.Rb)(e,o,n,t,0,r),e)}}var M=i(63054),R=i(44821),F=(i(40766),i(54709)),P=i(65175),z=i(75128),D={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = mod(v_accumulatedDistance / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = mod((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * v_lineHalfWidth;\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};const O=new z.Z(function(e){let t=D;return e.split("/").forEach(e=>{t&&(t=t[e])}),t});function I(e){return O.resolveIncludes(e)}const E=e=>(0,v.K)({ID:e.id,PATTERN:e.pattern}),B={shaders:e=>({vertexShader:E(e)+I("background/background.vert"),fragmentShader:E(e)+I("background/background.frag")})},A=e=>(0,v.K)({ID:e.id}),V={shaders:e=>({vertexShader:A(e)+I("circle/circle.vert"),fragmentShader:A(e)+I("circle/circle.frag")})},L=e=>(0,v.K)({ID:e.id,PATTERN:e.pattern}),k={shaders:e=>({vertexShader:L(e)+I("fill/fill.vert"),fragmentShader:L(e)+I("fill/fill.frag")})},U=e=>(0,v.K)({ID:e.id}),Z={shaders:e=>({vertexShader:U(e)+I("outline/outline.vert"),fragmentShader:U(e)+I("outline/outline.frag")})},N=e=>(0,v.K)({ID:e.id,SDF:e.sdf}),W={shaders:e=>({vertexShader:N(e)+I("icon/icon.vert"),fragmentShader:N(e)+I("icon/icon.frag")})},H=e=>(0,v.K)({ID:e.id,PATTERN:e.pattern,SDF:e.sdf}),q={shaders:e=>({vertexShader:H(e)+I("line/line.vert"),fragmentShader:H(e)+I("line/line.frag")})},G=e=>(0,v.K)({ID:e.id}),j={shaders:e=>({vertexShader:G(e)+I("text/text.vert"),fragmentShader:G(e)+I("text/text.frag")})};class ${constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,t,i){const s=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const r=this._getProgramTemplate(t.type),{shaders:n}=r,{vertexShader:a,fragmentShader:o}=n(i),h=t.getShaderHeader(),l=t.getShaderMain(),d=a.replace("#pragma header",h).replace("#pragma main",l),u=new P.$(e,d,o,t.getAttributeLocations());return this._programByKey.set(s,u),u}_getMaterialOptionsValue(e,t){switch(e){case 0:case 1:return(t.pattern?1:0)<<1|(t.id?1:0);case 2:return t.id?1:0;case 3:return(t.sdf?1:0)<<2|(t.pattern?1:0)<<1|(t.id?1:0);case 4:return(t.sdf?1:0)<<1|(t.id?1:0);case 5:case 6:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case 0:return B;case 5:return V;case 1:return k;case 4:return W;case 3:return q;case 2:return Z;case 6:return j;default:return null}}}var X=i(76014);const K={shaders:{vertexShader:(0,X.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,X.w)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class Y{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(e,t,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(1,771,1,771),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(5,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=K.attributes,i=(0,v.H)(e,K);if(!i)return!1;const s=new Int8Array(16);s[0]=-1,s[1]=-1,s[2]=0,s[3]=0,s[4]=1,s[5]=-1,s[6]=1,s[7]=0,s[8]=-1,s[9]=1,s[10]=0,s[11]=1,s[12]=1,s[13]=1,s[14]=1,s[15]=1;const r=new w.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:_.Z.createVertex(e,35044,s)});return this._program=i,this._vertexArrayObject=r,this._initialized=!0,!0}}var Q=i(21375);const J=e=>{let t="";t+=e[0].toUpperCase();for(let i=1;i<e.length;i++){const s=e[i];s===s.toUpperCase()?(t+="_",t+=s):t+=s.toUpperCase()}return t},ee=e=>{const t={};for(const i in e)t[J(i)]=e[i];return(0,v.K)(t)},te=(e,t,i)=>{const s=e+e.substring(e.lastIndexOf("/")),r=t+t.substring(t.lastIndexOf("/"));return{attributes:i,shaders:e=>({vertexShader:ee(e)+(0,X.w)(`${s}.vert`),fragmentShader:ee(e)+(0,X.w)(`${r}.frag`)})}},ie=e=>e===M.jx.HITTEST||e===M.jx.LABEL_ALPHA;class se{constructor(e){this._programByKey=new Map,this._programCache=new Q.Z(e)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(e,t,i=[],s=[]){const r=t.vsPath+"."+t.fsPath+JSON.stringify(i)+s.join(".");if(this._programByKey.has(r))return this._programByKey.get(r);const n=s.reduce((t,i)=>({...t,[i]:e.driverTestResult[i]}),{}),a={...i.map(e=>"string"==typeof e?{name:e,value:!0}:e).reduce((e,t)=>({...e,[t.name]:t.value}),{}),...n},{vsPath:o,fsPath:h,attributes:l}=t,d=this._programCache.getProgram(te(o,h,l),a);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,d),d}getMaterialProgram(e,t,i,s,r,n=["ignoresSamplerPrecision"]){const a=(({rendererInfo:e,drawPhase:t},i,s,r)=>{return`${i.getVariationHash()}-${r.join(".")}-${n=t,(ie(n)?1:0)|(n===M.jx.HIGHLIGHT?2:0)}-${e.getVariationHash()}-${(0,o.pC)(s)&&s.join(".")}`;var n})(e,t,r,n);if(this._programByKey.has(a))return this._programByKey.get(a);const h=((e,t,i,s)=>{const r=s.reduce((t,i)=>({...t,[i]:e.driverTestResult[i]}),{}),n={...t.getVariation(),...e.rendererInfo.getVariation(),highlight:e.drawPhase===M.jx.HIGHLIGHT,id:ie(e.drawPhase),...r};if((0,o.pC)(i))for(const a of i)n[a]=!0;return n})(e,t,r,n),l=this._programCache.getProgram(te(i,i,s),h);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,l),l}}var re=i(24065),ne=i(93668),ae=i(18419),oe=i(98154),he=i(85128),le=i(90585),de=i(72461),ue=i(10075),ce=i(47870);class pe{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new ce.Z(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new ce.Z;let i=null,s=-1;for(let r=0;r<this._free.length;++r){const n=this._free[r];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,s=r)}return null===i?new ce.Z:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new ce.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new ce.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new ce.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new ce.Z(i.x,i.y+t,e,i.height-t))),new ce.Z(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}const me=e=>Math.floor(e/256);class fe{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new pe(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let s=0;s<e.length;s++){const i=e[s];for(let e=0;e<11;e++)t.push(i)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}getGlyphItems(e,t,i){var r=this;return(0,s.Z)(function*(){const s=r._getGlyphCache(e);return yield r._fetchRanges(e,t,i),t.map(t=>r._getMosaicItem(s,e,t))})()}bind(e,t,i,s){const r=this._getTexture(e,i);r.setSamplingMode(t),this._dirties[i]&&(r.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(r,s)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new b.Z(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,t,i){var r=this;return(0,s.Z)(function*(){const s=function(e){const t=new Set;for(const i of e)t.add(me(i));return t}(t),n=[];s.forEach(t=>{n.push(r._fetchRange(e,t,i))}),yield Promise.all(n)})()}_fetchRange(e,t,i){var r=this;return(0,s.Z)(function*(){return t>256?null:function(e,t,i){return e.has(t)||e.set(t,i().then(()=>{e.delete(t)}).catch(i=>{e.delete(t),(0,oe.H9)(i)})),e.get(t)}(r._rangePromises,e+t,()=>r._glyphSource.getRange(e,t,i))})()}_getMosaicItem(e,t,i){if(!e[i]){const s=this._glyphSource.getGlyph(t,i);if(!s||!s.metrics)return(e=>({rect:new ce.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0}))(i);const r=this._recordGlyph(s);e[i]={rect:r,page:this._currentPage,metrics:s.metrics,code:i,sdf:!0},this._invalidate()}return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(0===t.width)i=new ce.Z(0,0,0,0);else{const s=3,r=t.width+2*s,n=t.height+2*s;i=this._binPack.allocate(r,n),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new pe(this.width-4,this.height-4),i=this._binPack.allocate(r,n));const o=this._glyphData[this._currentPage],h=e.bitmap;let l,d;if(h)for(let e=0;e<n;e++){l=r*e,d=this.width*(i.y+e)+i.x;for(let e=0;e<r;e++)o[d+e]=h[l+e]}(0,a.Z)("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),s=new ImageData(this.width,this.height),r=s.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let n=0;n<e.length;++n)r[4*n+0]=e[n],r[4*n+1]=0,r[4*n+2]=0,r[4*n+3]=255;i.putImageData(s,0,0),document.body.appendChild(t)}}var _e=i(39937);class ge{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const e=t.getMessage();let i,s,r,n,a,o,h;for(;e.next();)switch(e.tag()){case 1:i=e.getUInt32();break;case 2:s=e.getBytes();break;case 3:r=e.getUInt32();break;case 4:n=e.getUInt32();break;case 5:a=e.getSInt32();break;case 6:o=e.getSInt32();break;case 7:h=e.getUInt32();break;default:e.skip()}e.release(),i&&(this._metrics[i]={width:r,height:n,left:a,top:o,advance:h},this._bitmaps[i]=s);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class ve{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class ye{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const s=this._getFontStack(e);if(s.getRange(t))return Promise.resolve();const r=256*t,n=r+255,a=this._baseURL.replace("{fontstack}",e).replace("{range}",r+"-"+n);return(0,ne.default)(a,{responseType:"array-buffer",...i}).then(e=>{s.addRange(t,new ge(new _e.Z(new Uint8Array(e.data),new DataView(e.data))))})}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256);if(s>256)return;const r=i.getRange(s);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new ve),t}}const be=[1,256,65536,16777216],we=[1/256,1/65536,1/16777216,1/4294967296],xe=function(e,t=0){let i=0;for(let s=0;s<4;s++)i+=e[t+s]*we[s];return i}(new Uint8ClampedArray([255,255,255,255]));function Te(e,t,i=0){const s=function(e,t,i){return e<0?0:e>i?i:e}(e,0,xe);for(let n=0;n<4;n++)t[i+n]=Math.floor(256*((r=s*be[n])-Math.floor(r)));var r}const Se=1e20;class Ce{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const s=this._createSVGString(e);return new Promise((e,r)=>{const n=new Image;n.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),n.onload=()=>{n.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(n,0,0,this.size,this.size);const t=this._context.getImageData(0,0,this.size,this.size),s=new Uint8Array(this.size*this.size*4);for(let e=0;e<this.size*this.size;e++){const i=t.data[4*e+3]/255;this._gridOuter[e]=1===i?0:0===i?Se:Math.max(0,.5-i)**2,this._gridInner[e]=1===i?Se:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let e=0;e<this.size*this.size;e++)Te(.5-(this._gridOuter[e]-this._gridInner[e])/(2*i),s,4*e);e(s)};const a=t&&t.signal;a&&(0,oe.fu)(a,()=>r((0,oe.zE)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}_createSVGString(e){const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),s=i.width/i.height,r=this.size/2;let n,a,o,h;s>1?(a=n=r/i.width,o=this.size/4,h=r-r*(1/s)/2):(n=a=r/i.height,o=r-r*s/2,h=this.size/4),t.setAttribute("style",`transform: matrix(${n}, 0, 0, ${a}, ${-i.x*n+o}, ${-i.y*a+h})`);const l=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),l}_edt(e,t,i){const s=this._f,r=this._d,n=this._v,a=this._z;for(let o=0;o<t;o++){for(let r=0;r<i;r++)s[r]=e[r*t+o];this._edt1d(s,r,n,a,i);for(let s=0;s<i;s++)e[s*t+o]=r[s]}for(let o=0;o<i;o++){for(let i=0;i<t;i++)s[i]=e[o*t+i];this._edt1d(s,r,n,a,t);for(let i=0;i<t;i++)e[o*t+i]=Math.sqrt(r[i])}}_edt1d(e,t,i,s,r){i[0]=0,s[0]=-Se,s[1]=+Se;for(let n=1,a=0;n<r;n++){let t=(e[n]+n*n-(e[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);for(;t<=s[a];)a--,t=(e[n]+n*n-(e[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);a++,i[a]=n,s[a]=t,s[a+1]=+Se}for(let n=0,a=0;n<r;n++){for(;s[a+1]<n;)a++;t[n]=(n-i[a])*(n-i[a])+e[i[a]]}}}var Me=i(62311);function Re(e){return e&&"static"===e.type}class Fe{constructor(e,t,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,this._requestRender=e,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new pe(this._pageWidth,this._pageHeight);const r=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,s,r,n){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let a,o,h;if(Re(i)?[a,o,h]=this._allocateImage(t[0],t[1]):(a=new ce.Z(0,0,t[0],t[1]),o=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:t,dirty:!0,texture:void 0})),a.width<=0||a.height<=0)return null;const l={rect:a,width:t[0],height:t[1],sdf:r,simplePattern:n,pixelRatio:1,page:o};return this._mosaicRects.set(e,l),Re(i)&&this._copy({rect:a,spriteSize:t,spriteData:i.data,page:o,pageSize:h,repeat:s,sdf:r}),l}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const s=ue.fL,r=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+s)/r[0],(i.y+s)/r[1]],br:[(i.x+s+t.width)/r[0],(i.y+s+t.height)/r[1]],page:t.page}}bind(e,t,i=0,s=0){const r=this._mosaicPages[i],n=r.mosaicsData;let a=r.texture;if(a||(a=function(e,t,i){return Re(t)?new b.Z(e,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new b.Z(e,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(e,n,r.size),r.texture=a),a.setSamplingMode(t),Re(n))e.bindTexture(a,s),r.dirty&&(a.setData(new Uint8Array(n.data.buffer)),a.generateMipmap());else{const t=n.data,i=t.bindFrame(e,a,s);(0,o.pC)(this._requestRender)&&i&&t.frameCount>0&&this._requestRender.requestRender(),t.bindFrame(e,a,s)}r.dirty=!1}static _copyBits(e,t,i,s,r,n,a,o,h,l,d){let u=s*t+i,c=o*n+a;if(d){c-=n;for(let a=-1;a<=l;a++,u=((a+l)%l+s)*t+i,c+=n)for(let t=-1;t<=h;t++)r[c+t]=e[u+(t+h)%h]}else for(let p=0;p<l;p++){for(let t=0;t<h;t++)r[c+t]=e[u+t];u+=t,c+=n}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!Re(t.mosaicsData))throw new r.Z("mapview-invalid-resource","unsuitable data type!");const s=e.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),Fe._copyBits(s,e.spriteSize[0],0,0,n,e.pageSize[0],e.rect.x+ue.fL,e.rect.y+ue.fL,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*ue.fL,t+=2*ue.fL;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil((0,Me.k3)(e)),s=2**Math.ceil((0,Me.k3)(t)),r=new ce.Z(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[r,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(e,t);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&Re(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new pe(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;Re(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}const Pe=new Uint32Array(256);for(let ts=0;ts<256;ts++){let e=ts;for(let t=0;t<8;t++)e=0!=(1&e)?3988292384^e>>>1:e>>>1;Pe[ts]=e}const ze=new r.Z("Not a PNG"),De=new r.Z("Not an animated PNG"),Oe=new Uint8Array([137,80,78,71,13,10,26,10]);function Ie(e){const t=e.constructor===Uint8Array?e:new Uint8Array(e);return!Oe.some((e,i)=>e!==t[i])}class Ee{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static create(e,t){return(0,s.Z)(function*(){const i=new Ee;try{yield i._load(e,t)}catch(s){if(!(0,oe.D_)(s))return new r.Z("invalid-resource",`Could not load PNG: ${s.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(!s)return!1;const r=this.currentFrame,n=r.frameData,a=t.descriptor;return(r.left||r.top||r.width!==a.width||r.height!==a.height)&&t.setData(null),t.updateData(0,r.left,r.top,r.width,r.height,n),this.updateUsedFrame(),s}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(e,t){var i=this;return(0,s.Z)(function*(){try{const t=function(e,t){const i=new Uint8Array(t);if(Oe.some((e,t)=>e!==i[t]))return ze;let s=!1;if(Ae(i,e=>!(s="acTL"===e)),!s)return De;const r=[],n=[];let a=null,o=null,h=0;if(Ae(i,(t,i,s,l)=>{const d=new DataView(i.buffer);switch(t){case"IHDR":a=i.subarray(s+8,s+8+l),e.width=d.getUint32(s+8),e.height=d.getUint32(s+12);break;case"acTL":e.numPlays=d.getUint32(s+8+4);break;case"fcTL":{o&&(e.frames.push(o),h++),o=new Be,o.width=d.getUint32(s+8+4),o.height=d.getUint32(s+8+8),o.left=d.getUint32(s+8+12),o.top=d.getUint32(s+8+16);const t=d.getUint16(s+8+20);let i=d.getUint16(s+8+22);0===i&&(i=100),o.delay=1e3*t/i,o.delay<=10&&(o.delay=100),e.playTime+=o.delay,o.disposeOp=d.getUint8(s+8+24),o.blendOp=d.getUint8(s+8+25),o.dataParts=[],0===h&&2===o.disposeOp&&(o.disposeOp=1);break}case"fdAT":o&&o.dataParts.push(i.subarray(s+8+4,s+8+l));break;case"IDAT":o&&o.dataParts.push(i.subarray(s+8,s+8+l));break;case"IEND":n.push(Le(i,s,12+l));break;default:r.push(Le(i,s,12+l))}}),0===e.frames.length)return De;e.frameCount=e.frames.length;const l=new Blob(r),d=new Blob(n);return e.frames.forEach(e=>{let t=[];t.push(Oe),a.set(Ue(e.width),0),a.set(Ue(e.height),4),t.push(ke("IHDR",a)),t.push(l),e.dataParts.forEach(e=>t.push(ke("IDAT",e))),t.push(d),e.data=new Blob(t,{type:"image/png"}),delete e.dataParts,t=null}),e}(i,e);if(t!==i)return t;i._resizeCanvas=document.createElement("canvas"),i._resizeCanvas.width=i.width,i._resizeCanvas.height=i.height,yield Promise.all(i.frames.map(e=>e.createImage(i._resizeCanvas)))}catch(A){if(!(0,oe.D_)(A))return new r.Z("invalid-resource","Could not parse PNG")}i.play()})()}_play(){let e,t;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout(()=>this._play(),e)}}class Be{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}createImage(e){var t=this;return(0,s.Z)(function*(){if(null===t.imageData)return new Promise((i,s)=>{const r=URL.createObjectURL(t.data),n=document.createElement("img");n.onload=()=>{URL.revokeObjectURL(r),t.imageData=function(e,t){t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),r=new Uint8Array(s.data);let n;for(let a=0;a<r.length;a+=4)n=r[a+3]/255,r[a]=r[a]*n,r[a+1]=r[a+1]*n,r[a+2]=r[a+2]*n;return new ImageData(new Uint8ClampedArray(r.buffer),e.width,e.height)}(n,e),i()},n.onerror=()=>{URL.revokeObjectURL(r),t.imageData=null,s(new Error("Image creation error"))},n.src=r})})()}}function Ae(e,t){const i=new DataView(e.buffer);let s,r,n,a=8;do{r=i.getUint32(a),s=Ve(e,a+4,4),n=t(s,e,a,r),a+=12+r}while(!1!==n&&"IEND"!==s&&a<e.length)}function Ve(e,t,i){const s=Array.prototype.slice.call(e.subarray(t,t+i));return String.fromCharCode.apply(String,s)}function Le(e,t,i){const s=new Uint8Array(i);return s.set(e.subarray(t,t+i)),s}function ke(e,t){const i=e.length+t.length,s=new Uint8Array(i+8),r=new DataView(s.buffer);r.setUint32(0,t.length),s.set(function(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}(e),4),s.set(t,8);const n=function(e,t=0,i=e.length-t){let s=-1;for(let r=t,n=t+i;r<n;r++)s=s>>>8^Pe[255&(s^e[r])];return-1^s}(s,4,i);return r.setUint32(i+4,n),s}function Ue(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}function Ze(e){if(!e||0===e.byteLength)return!1;const t=e.constructor===Uint8Array?e:new Uint8Array(e);return 71===t[0]&&73===t[1]&&70===t[2]&&56===t[3]}class Ne{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static create(e,t){return(0,s.Z)(function*(){const i=new Ne;try{yield i._load(e,t)}catch(s){if(!(0,oe.D_)(s))return new r.Z("invalid-resource",`Could not load PNG: ${s.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(s){const e=this.currentFrame;t.updateData(0,0,0,e.width,e.height,e.frameData),this.updateUsedFrame()}return s}seekFrame(e){clearTimeout(this.timerID),this.currentFrameNumber=e%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(e){clearTimeout(this.timerID),e<0&&(e=0),e*=1e3,e%=this.length;let t=0;for(;e>this.frames[t].time+this.frames[t].delay&&t<this.frames.length;)t+=1;this.currentFrameNumber=t,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(e,t){var i=this;return(0,s.Z)(function*(){try{i.loading=!0,yield i._parse(e,t),i.loading=!1,i.play()}catch(B){if(!(0,oe.D_)(B))return new r.Z("invalid-resource","Could not parse gif!")}})()}_parse(e,t){const i=new We(e);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const s=i.data[i.pos++];return this.globalColourCount=1<<1+(7&s),i.pos++,i.pos++,128&s&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise((e,s)=>{setTimeout(()=>this._parseBlock(i,e,s,t),0)})}_parseBlock(e,t,i,r){var n=this;return(0,s.Z)(function*(){if(r&&r.signal&&(0,oe.Hc)(r.signal))return void i((0,oe.zE)());const s=e.data[e.pos++];if(44===s){if(n._parseImg(e),n.firstFrameOnly)return n._finishedLoading(),void t()}else{if(59===s)return n._finishedLoading(),void t();n._parseExt(e)}"function"==typeof n.onprogress&&n.onprogress({bytesRead:e.pos,totalBytes:e.data.length,frame:n.frames.length}),setTimeout(()=>n._parseBlock(e,t,i,r),0)})()}_parseColourTable(e,t){const i=[];for(let s=0;s<e;s++)i.push([t.data[t.pos++],t.data[t.pos++],t.data[t.pos++]]);return i}_parseImg(e){const t={};this.frames.push(t),t.disposalMethod=this.disposalMethod,t.time=this.length,t.delay=10*this.delayTime,this.length+=t.delay,t.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0,t.leftPos=e.data[e.pos++]+(e.data[e.pos++]<<8),t.topPos=e.data[e.pos++]+(e.data[e.pos++]<<8),t.width=e.data[e.pos++]+(e.data[e.pos++]<<8),t.height=e.data[e.pos++]+(e.data[e.pos++]<<8);const i=e.data[e.pos++];t.localColourTableFlag=!!(128&i),t.localColourTableFlag&&(t.localColourTable=this._parseColourTable(1<<1+(7&i),e)),this.pixelBufSize!==t.width*t.height&&(this.pixelBuf=new Uint8Array(t.width*t.height),this.pixelBufSize=t.width*t.height),this._lzwDecode(e.data[e.pos++],e.readSubBlocksB()),64&i?(t.interlaced=!0,(e=>{const t=this.pixelBufSize/e;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let i=0;for(let s=0;s<4;s++)for(let r=this.interlaceOffsets[s];r<t;r+=this.interlaceSteps[s])this.deinterlaceBuf.set(this.pixelBuf.subarray(i,i+e),r*e),i+=e})(t.width)):t.interlaced=!1,this._processFrame(t)}_lzwDecode(e,t){let i,s,r,n,a,o,h,l,d;r=s=0;let u=[];const c=1<<e,p=c+1;for(n=e+1,d=!1;!d;){for(o=a,a=0,i=0;i<n;i++)t[r>>3]&1<<(7&r)&&(a|=1<<i),r++;if(a===c){for(u=[],n=e+1,i=0;i<c;i++)u[i]=[i];u[c]=[],u[p]=null}else{if(a===p)return void(d=!0);for(a>=u.length?u.push(u[o].concat(u[o][0])):o!==c&&u.push(u[o].concat(u[a][0])),h=u[a],l=h.length,i=0;i<l;i++)this.pixelBuf[s++]=h[i];u.length===1<<n&&n<12&&n++}}}_processFrame(e){e.image=document.createElement("canvas"),e.image.width=this.width,e.image.height=this.height,e.ctx=e.image.getContext("2d");const t=e.localColourTableFlag?e.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=e);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||e.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const s=e.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),r=e.transparencyIndex,n=s.data,a=e.interlaced?this.deinterlaceBuf:this.pixelBuf,o=a.length;let h,l,d=0;for(let u=0;u<o;u++)h=a[u],l=t[h],r!==h?(n[d++]=l[0],n[d++]=l[1],n[d++]=l[2],n[d++]=255):i?(n[d+3]=0,d+=4):d+=4;e.ctx.putImageData(s,e.leftPos,e.topPos),this.lastFrame=e}_parseExt(e){const t=e.data[e.pos++];249===t?this._parseGCExt(e):254===t?this.comment+=e.readSubBlocks():255===t?this._parseAppExt(e):(1===t&&(e.pos+=13),e.readSubBlocks())}_parseAppExt(e){e.pos+=1,"NETSCAPE"===e.getString(8)?e.pos+=8:(e.pos+=3,e.readSubBlocks())}_parseGCExt(e){e.pos++;const t=e.data[e.pos++];this.disposalMethod=(28&t)>>2,this.transparencyGiven=!!(1&t),this.delayTime=e.data[e.pos++]+(e.data[e.pos++]<<8),this.transparencyIndex=e.data[e.pos++],e.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let e,t;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(()=>this._play(),e)):this.pause()}_setCurrentFrame(e){this.currentFrame={frameData:this.frames[e].image,top:0,left:0,width:this.width,height:this.height}}}class We{constructor(e){this.pos=0,this.data=new Uint8ClampedArray(e),this.len=this.data.length}getString(e){let t="";for(;e--;)t+=String.fromCharCode(this.data[this.pos++]);return t}readSubBlocks(){let e,t,i="";do{for(t=e=this.data[this.pos++];t--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}readSubBlocksB(){let e,t;const i=[];do{for(t=e=this.data[this.pos++];t--;)i.push(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}}var He=i(80055),qe=i(87630),Ge=i(29981);const je=(0,le.c)(),$e="arial-unicode-ms-regular",Xe=ae.Z.getLogger("esri.views.2d.engine.webgl.TextureManager"),Ke=e=>"esriSMS"===e.type&&e.path;function Ye(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function Qe(e){return"maxVVSize"in e&&e.maxVVSize||e.width}function Je(){return(Je=(0,s.Z)(function*(e,t){const i=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;let s;const n=";base64,";if(-1!==i.indexOf(n)){const e=i.indexOf(n)+n.length,t=i.substring(e),r=atob(t),a=new Uint8Array(r.length);for(let i=0;i<r.length;i++)a[i]=r.charCodeAt(i);s=a.buffer}else try{const{data:e}=yield(0,ne.default)(i,{responseType:"array-buffer",...t});s=e}catch(H){if(!(0,oe.D_)(H))return new r.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`)}return s})).apply(this,arguments)}function et(e,t){const i=Math.round((0,he.F2)(t)*window.devicePixelRatio);return Math.min(e,i*(i>=128?2:4))}const tt=(e,t,i)=>Xe.error(new r.Z(e,t,i));class it{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new it(e,t.page,t.sdf)}}class st{constructor(e){var t;this._invalidFontsMap=new Map,this._sdfConverter=new Ce(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new de.Z,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Ge.e({concurrency:10,process:(t=(0,s.Z)(function*(e,t){(0,oe.k_)(t);try{return yield(0,ne.default)(e,{responseType:"image",signal:t})}catch(i){if(!(0,oe.D_)(i))throw new r.Z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,i);throw i}}),function(e,i){return t.apply(this,arguments)})}),this._spriteMosaic=new Fe(e,2048,2048,500),this._glyphSource=new ye(`${re.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new fe(1024,1024,this._glyphSource)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}rasterizeItem(e,t,i,r){var n=this;return(0,s.Z)(function*(){if((0,o.Wi)(e))return tt("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"CIMTextSymbol":case"esriTS":{const t=yield n._rasterizeText(e,i,r);return t.forEach(e=>n._setTextureBinding(M.Un.GLYPH,e)),{glyphMosaicItems:t}}default:{if((e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d"))(e))return tt("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const i=yield n._rasterizeSpriteSymbol(e,t,r);return(0,qe.ok)(i)&&i&&n._setTextureBinding(M.Un.SPRITE,i),{spriteMosaicItem:i}}}})()}bindTextures(e,t,i,s=!1){if(0===i.textureBinding)return;const r=this._bindingInfos[i.textureBinding-1],n=r.page,a=s?9987:9729;switch(r.mosaicType){case M.Un.SPRITE:{const i=this.sprites.getWidth(n),s=this.sprites.getHeight(n),r=(0,m.s)(je,i,s);return this._spriteMosaic.bind(e,a,n,ue.D3),t.setUniform1i("u_texture",ue.D3),void t.setUniform2fv("u_mosaicSize",r)}case M.Un.GLYPH:{const i=(0,m.s)(je,this.glyphs.width,this.glyphs.height);return this._glyphMosaic.bind(e,a,n,ue.Al),t.setUniform1i("u_texture",ue.Al),void t.setUniform2fv("u_mosaicSize",i)}default:Xe.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=it.fromMosaic(e,t);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}_rasterizeText(e,t,i){var r=this;return(0,s.Z)(function*(){const s=function(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblic":return"-italic"}return""}(e);return function(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}(e.family)+(t.length>0?t:"-regular")}(e.font),n=r._invalidFontsMap.has(s),a=t||function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}((0,He.E)(e.text)[0]);try{return yield r._glyphMosaic.getGlyphItems(n?$e:s,a,i)}catch(Z){return tt("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),r._invalidFontsMap.set(s,!0),r._glyphMosaic.getGlyphItems($e,a,i)}})()}_rasterizeSpriteSymbol(e,t,i){var n=this;return(0,s.Z)(function*(){if(function(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}(e))return null;const t=function(e){switch(e.type){case"esriSMS":return`${e.style}.${e.path}`;case"esriSLS":return`${e.style}.${e.cap}`;case"esriSFS":return`${e.style}`;case"esriPFS":case"esriPMS":return e.imageData?`${e.imageData}${e.width}${e.height}`:`${e.url}${e.width}${e.height}`;default:return e.mosaicHash?e.mosaicHash:JSON.stringify(e)}}(e);if(n._spriteMosaic.has(t))return n._spriteMosaic.getSpriteItem(t);if(Ke(e)||(e=>e.url||e.imageData)(e))return n._handleAsyncResource(t,e,i);const s=n._rasterizer.rasterizeJSONResource(e,1);if(s){const{size:i,image:r,sdf:a,simplePattern:o}=s;return n._addItemToMosaic(t,i,{type:"static",data:r},Ye(e),a,o)}return new r.Z("TextureManager","unrecognized or null rasterized image")})()}_handleAsyncResource(e,t,i){var r=this;return(0,s.Z)(function*(){if(r._ongoingRasterizations.has(e))return r._ongoingRasterizations.get(e);let s;s=Ke(t)?r._handleSVG(t,e,i):r._handleImage(t,e,i),r._ongoingRasterizations.set(e,s);try{yield s,r._ongoingRasterizations.delete(e)}catch{r._ongoingRasterizations.delete(e)}return s})()}_handleSVG(e,t,i){var r=this;return(0,s.Z)(function*(){const s=yield r._sdfConverter.draw(e.path,i);return r._addItemToMosaic(t,[126,126],{type:"static",data:new Uint32Array(s.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,t,i){var n=this;return(0,s.Z)(function*(){const s=yield function(e,t){return Je.apply(this,arguments)}(e,i);if((0,qe.ok)(s)){const a=Ze(s),o=Ie(s);if(!a&&!o)return new r.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let h;try{a&&function(e){if(!e||0===e.byteLength)return!1;const t=new Uint8Array(e);if(!Ze(t))return!1;let i=0;for(let s=0,r=t.length-9;s<r&&(0!==t[s]||33!==t[s+1]||249!==t[s+2]||4!==t[s+3]||0!==t[s+8]||44!==t[s+9]&&33!==t[s+9]||(i++,!(i>1)));++s);return i>1}(s)?h=yield Ne.create(s,i):o&&function(e){const t=new Uint8Array(e);if(!Ie(t))return!1;let i=!1;return Ae(t,e=>!(i="acTL"===e)),i}(s)&&(h=yield Ee.create(s,i))}catch(B){if(!(0,oe.D_)(B))return new r.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(h&&(0,qe.ok)(h))return n._addItemToMosaic(t,[h.width,h.height],{type:"animated",data:h},Ye(e),!1,!1);const l=new Blob([s],{type:a?"image/gif":"image/png"}),d=yield n._imageFromBlob(l);if(d&&d instanceof HTMLImageElement){let i=d.width,s=d.height;"esriPMS"===e.type&&(i=Math.round(et(d.width,Qe(e))),s=Math.round(d.height*(i/d.width)));const{size:r,sdf:a,image:o}=n._rasterizer.rasterizeImageResource(i,s,d,e.colorSubstitutions);return n._addItemToMosaic(t,r,{type:"static",data:o},Ye(e),a,!1)}}return new r.Z("mapview-invalid-resource","Could not handle resource!")})()}_handleImage(e,t,i){var n=this;return(0,s.Z)(function*(){if((e=>e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif"))(e)||(e=>e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png"))(e))return n._handleGIFOrPNG(e,t,i);const s=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;try{const{data:r}=yield n._imageRequestQueue.push(s,{...i});(e=>-1!==e.indexOf("data:image/svg+xml"))(s)&&(r.width=(0,he.F2)(e.width),r.height=(0,he.F2)(e.height));let a=r.width,o=r.height;"esriPMS"===e.type&&(a=Math.round(et(r.width,Qe(e))),o=Math.round(r.height*(a/r.width)));const{size:h,sdf:l,image:d}=n._rasterizer.rasterizeImageResource(a,o,r,e.colorSubstitutions);return n._addItemToMosaic(t,h,{type:"static",data:d},Ye(e),l,!1)}catch(B){if(!(0,oe.D_)(B))return new r.Z("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${B.message}`)}})()}_imageFromBlob(e){var t=this;return(0,s.Z)(function*(){const i=window.URL.createObjectURL(e);try{const{data:e}=yield t._imageRequestQueue.push(i);return window.URL.revokeObjectURL(i),e}catch(s){if(window.URL.revokeObjectURL(i),!(0,oe.D_)(s))return new r.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`);throw s}})()}_addItemToMosaic(e,t,i,s,r,n){return this._spriteMosaic.addSpriteItem(e,t,i,s,r,n)}}var rt=i(66618);class nt{constructor(){this.name=this.constructor.name}}class at extends nt{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new rt.Z(i,[0,0,1,0,0,1,1,1]));const r=i.getBoundFramebufferObject(),{x:n,y:a,width:h,height:l}=i.getViewport();t.bindTextures(i);const d=t.getBlock(ue.xl);if((0,o.Wi)(d))return;const u=d.getFBO(i),c=d.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,c,s.labelsAnimationTime),this._updateAnimationState(e,c,u),i.bindFramebuffer(r),i.setViewport(n,a,h,l)}_computeDelta(e,t,i){const{context:s,painter:r,displayLevel:n}=e,a=r.materialManager.getProgram(e,this._desc,["delta"]);s.bindFramebuffer(t),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.useProgram(a),a.setUniform1i("u_maskTexture",ue.iJ),a.setUniform1i("u_sourceTexture",ue.nM),a.setUniform1f("u_timeDelta",e.deltaTime),a.setUniform1f("u_animationTime",i),a.setUniform1f("u_zoomLevel",Math.round(10*n)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:s,painter:r}=e,n=r.materialManager.getProgram(e,this._desc,["update"]);s.bindTexture(t.colorTexture,1),s.useProgram(n),n.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const ot=e=>`#define ${(e=>e.replace("-","_").toUpperCase())(e)}\n`,ht={attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:e=>({vertexShader:ot(e)+(0,X.w)("blend/blend.vert"),fragmentShader:ot(e)+(0,X.w)("blend/blend.frag")})},lt=ae.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class dt{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(e,t,i,s,n){const{context:a,drawPhase:o}=e;if(this._setupShader(a),s&&"normal"!==s&&o!==M.jx.LABEL)return void this._drawBlended(e,t,i,s,n);const h=this._programCache.getProgram(ht,"normal");if(!h)return void lt.error(new r.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(h),t.setSamplingMode(i),a.bindTexture(t,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(1,771);const l=this._quad;l.draw(),l.unbind()}_drawBlended(e,t,i,s,n){const{context:a,state:h,pixelRatio:l,inFadeTransition:d}=e,{size:u}=h,c=a.getBoundFramebufferObject();let p,m;if((0,o.pC)(c)){const e=c.descriptor;p=e.width,m=e.height}else p=Math.round(l*u[0]),m=Math.round(l*u[1]);this._createOrResizeTexture(e,p,m);const f=this._backBufferTexture;c.copyToTexture(0,0,p,m,0,0,f),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const _=this._programCache.getProgram(ht,s);if(!_)return void lt.error(new r.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));a.useProgram(_),f.setSamplingMode(i),a.bindTexture(f,0),_.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),a.bindTexture(t,1),_.setUniform1i("u_layerTexture",1),_.setUniform1f("u_opacity",n),_.setUniform1f("u_inFadeOpacity",d?1:0),a.setBlendFunction(1,0);const g=this._quad;g.draw(),g.unbind(),a.setBlendFunction(1,771)}_setupShader(e){this._programCache||(this._programCache=new Q.Z(e),this._quad||(this._quad=new rt.Z(e,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(e,t,i){const{context:s}=e;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new b.Z(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class ut extends nt{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:s}=e.getViewport(),r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:s,state:r,deltaTime:n}=e,a=s.getPostProcessingEffects(t.effects),o=i.getBoundFramebufferObject();a.length&&t.transitionStep(n,r.scale);for(const{postProcessingEffect:h,effect:l}of a)h.draw(e,o,l);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,o.colorTexture,9728),i.setStencilTestEnabled(!0)}}const ct=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],pt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],mt=ae.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),ft=[0,0,0,0];class _t{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:.7,innerHaloWidth:.7,outerHaloWidth:.7},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;!function(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=.7,t.outerHaloWidth=.7,t.innerHaloWidth=.7,t.outlinePosition=0}(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,s=t.outlinePosition-t.outlineWidth/2,r=t.outlinePosition+t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,a=1*Math.sqrt(Math.PI/2),o=Math.abs(i)>a?Math.round(10*(Math.abs(i)-a))/10:0,h=Math.abs(n)>a?Math.round(10*(Math.abs(n)-a))/10:0;let l;o&&!h?mt.error("The outer rim of the highlight is "+o+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!o&&h?mt.error("The inner rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):o&&h&&mt.error("The highlight is "+Math.max(o,h)+"px away from the edge of the feature; consider reducing some width values.");const d=[void 0,void 0,void 0,void 0];function u(e,t,i){d[0]=(1-i)*e[0]+i*t[0],d[1]=(1-i)*e[1]+i*t[1],d[2]=(1-i)*e[2]+i*t[2],d[3]=(1-i)*e[3]+i*t[3]}const{texelData:c}=this;for(let p=0;p<256;++p)l=i+p/255*(n-i),l<i?(d[4*p+0]=0,d[4*p+1]=0,d[4*p+2]=0,d[4*p+3]=0):l<s?u(ft,t.outlineColor,(l-i)/(s-i)):l<r?[d[0],d[1],d[2],d[3]]=t.outlineColor:l<n?u(t.outlineColor,t.fillColor,(l-r)/(n-r)):[d[4*p+0],d[4*p+1],d[4*p+2],d[4*p+3]]=t.fillColor,c[4*p+0]=255*d[0],c[4*p+1]=255*d[1],c[4*p+2]=255*d[2],c[4*p+3]=255*d[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=n,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new b.Z(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,ue.Jw),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const gt={shaders:{vertexShader:(0,X.w)("highlight/textured.vert"),fragmentShader:(0,X.w)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},vt={shaders:{vertexShader:(0,X.w)("highlight/textured.vert"),fragmentShader:(0,X.w)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class yt{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,ue.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",ct),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,ue.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",pt),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,ue.QU),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(1,771),e.drawArrays(5,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const s=_.Z.createVertex(e,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),r=new w.Z(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:s}),n=(0,v.H)(e,gt),a=(0,v.H)(e,vt);n.setUniform1i("u_texture",ue.QU),n.setUniform1i("u_shade",ue.Jw),n.setUniform1f("u_sigma",1),a.setUniform1i("u_texture",ue.QU),a.setUniform1f("u_sigma",1),this._resources={quadGeometry:s,quadVAO:r,highlightProgram:n,blurProgram:a}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}function bt(e,t,i){const s=new b.Z(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:t,height:i,samplingMode:9729});return[s,new g.Z(e,{colorTarget:0,depthStencilTarget:2},s)]}class wt{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[s,r]=bt(e,t,i),[n,a]=bt(e,t,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:r,sharedBlur2Tex:n,sharedBlur2Fbo:a}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class xt extends nt{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new yt,this._hlGradient=new _t,this._width=void 0,this._height=void 0,this._hlSurfaces=new wt,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Y}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:s,height:r}=t.getViewport(),n=i.getFbos(s,r).effect0;this.setup(e,s,r),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const s=t%4,r=i%4;i+=r<2?-r:4-r,this._adjustedWidth=t+=s<2?-s:4-s,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const n=Math.round(1*t),a=Math.round(1*i);this._hlRenderer.setup(e,n,a),this._hlSurfaces.setup(e,n,a)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,9728,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class Tt extends nt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,o.pC)(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:s}=e.getViewport(),r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw({context:e,state:t,pixelRatio:i},s,r=ue.Jc){const n=e.getBoundFramebufferObject(),a=t.size[1]*i,o=Math.round(r*i),h=o/2,l=o/2;this._ensureBuffer(o),s.forEach((e,t)=>{const r=new Map,d=Math.floor(t[0]*i-o/2),u=Math.floor(a-t[1]*i-o/2);n.readPixels(d,u,o,o,6408,5121,this._buf);for(let i=0;i<this._buf32.length;i++){const e=this._buf32[i];if(4294967295!==e&&0!==e){const t=i%o,s=o-Math.floor(i/o),n=(h-t)*(h-t)+(l-s)*(l-s),a=r.has(e)?r.get(e):4294967295;r.set(e,Math.min(n,a))}}const c=Array.from(r).sort((e,t)=>e[1]-t[1]).map(e=>e[0]);e.resolve(c),s.delete(t)})}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}function St(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}const Ct={colorize:(zt=(0,s.Z)(function*(){return new((yield i.e(2248).then(i.bind(i,72248))).Colorize)}),function(){return zt.apply(this,arguments)}),blur:(Pt=(0,s.Z)(function*(){return new((yield i.e(3649).then(i.bind(i,43649))).Blur)}),function(){return Pt.apply(this,arguments)}),bloom:(Ft=(0,s.Z)(function*(){return new((yield i.e(6876).then(i.bind(i,6876))).Bloom)}),function(){return Ft.apply(this,arguments)}),opacity:(Rt=(0,s.Z)(function*(){return new((yield i.e(8347).then(i.bind(i,98347))).Opacity)}),function(){return Rt.apply(this,arguments)}),"drop-shadow":(Mt=(0,s.Z)(function*(){return new((yield i.e(4335).then(i.bind(i,24335))).DropShadow)}),function(){return Mt.apply(this,arguments)})};var Mt,Rt,Ft,Pt,zt;class Dt{constructor(e){this._requestRender=e,this._effectMap=new Map,this._effectPromiseMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear(),this._effectPromiseMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const t=[];for(const i of e){const e=St(i.type),s=this._effectMap.get(e);s?t.push({postProcessingEffect:s,effect:i}):this._enablePostProcessingEffect(e)}return t}_enablePostProcessingEffect(e){var t=this;return(0,s.Z)(function*(){const i=yield t._loadPostProcessingEffect(e);t._requestRender&&(t._effectMap.set(e,i),t._requestRender.requestRender())})()}_loadPostProcessingEffect(e){var t=this;return(0,s.Z)(function*(){return t._effectPromiseMap.has(e)||t._effectPromiseMap.set(e,Ct[e]()),t._effectPromiseMap.get(e)})()}}var Ot=i(93476);class It{constructor(e,t){var i;this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||M.jx.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=null!=(i=t.enableDefaultDraw)?i:()=>!0}render(e){const{context:t,profiler:i}=e,s=this._targetFn(),r=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),r){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const n=r.apply;i.recordPassStart(this.name+"."+n.name),i.recordBrushStart(n.name);const a=r.args&&r.args(),{x:o,y:h,width:l,height:d}=t.getViewport(),u=t.getBoundFramebufferObject();n.bind(e,a),this._doRender(e,s,n.defines),n.draw(e,a),n.unbind(e,a),t.bindFramebuffer(u),t.setViewport(o,h,l,d),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!(0,o.Wi)(t))if((0,Ot.zG)(t)){for(const s of t)if(s.visible)for(const t of this.brushes)e.profiler.recordBrushStart(t.name),t.prepareState(e,s,i),t.draw(e,s,i),e.profiler.recordBrushEnd()}else for(const s of this.brushes)e.profiler.recordBrushStart(s.name),s.prepareState(e,t,i),s.draw(e,t,i),e.profiler.recordBrushEnd()}}const Et={[M.LW.FILL]:F.U.fill,[M.LW.LINE]:F.U.line,[M.LW.MARKER]:F.U.marker,[M.LW.TEXT]:F.U.text};class Bt{constructor(e,t){this.context=e,this._blitRenderer=new Y,this._brushCache=new Map,this._vtlMaterialManager=new $,this._blendEffect=new dt,this.effects={highlight:new xt,hittest:new Tt,integrate:new at,insideEffect:new ut("inside"),outsideEffect:new ut("outside")},this.materialManager=new se(e),this.textureManager=new st(t),this._effectsManager=new Dt(t)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},s={colorTarget:0,depthStencilTarget:3},r=new R.Z(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=r,this._fbos={output:new g.Z(this.context,s,i,r),blend:new g.Z(this.context,s,i,r),effect0:new g.Z(this.context,s,i,r)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:s}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const r=this.getFbos(i,s);if(e.bindFramebuffer(r.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),(0,o.pC)(t)){const{r:i,g:s,b:r,a:n}=t.color;e.setClearColor(n*i/255,n*s/255,n*r/255,n)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:s,blendMode:r,effects:n,requireFBO:a}=e;if(a||At(r,n,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const e=this._getOutputFBO();s.bindFramebuffer(e)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:s,effects:r,requireFBO:n}=e;if(n||At(s,r,t)){(0,o.pC)(r)&&r.length>0&&e.drawPhase===M.jx.MAP&&this._applyEffects(e,r);const n=this._getOutputFBO();i.bindFramebuffer(n),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);const a=(0,o.pC)(s)?s:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,a,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(e){const t=Et[e];let i=this._brushCache.get(t);return void 0===i&&(i=new t,this._brushCache.set(t,i)),this._brushCache.get(t)}renderObject(e,t,i,s){const r=F.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.prepareState(e,t,s),n.draw(e,t,s)}renderObjects(e,t,i,s){const r=F.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.drawMany(e,t,s)}registerRenderPass(e){const t=e.brushes.map(e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e)));return new It(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,s)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,s=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:r,effect:n}of s)i.bindFramebuffer(this._fbos.blend),r.draw(e,this._fbos.blend,n)}}function At(e,t,i){return 1!==i||(0,o.pC)(e)&&"normal"!==e||(0,o.pC)(t)&&t.length>0}var Vt=i(84433),Lt=i(70222),kt=i(76564);const Ut=(0,a.Z)("esri-2d-profiler");class Zt{constructor(e,t){if(this._events=new Lt.Z,this._entries=new Map,this._timings=new Vt.Z(10),!Ut)return;this._ext=(0,kt.m)(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging)for(const s in i)if("function"==typeof i[s]){const e=i[s],t=-1!==s.indexOf("draw");i[s]=(...r)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:s,args:r,isDrawCommand:t}),this._currentSummary&&(this._currentSummary.commands++,t&&this._currentSummary.drawCommands++),e.apply(i,r))}}get enableCommandLogging(){return!("object"==typeof Ut&&Ut.disableCommands)}recordContainerStart(e){Ut&&(this._currentContainer=e)}recordContainerEnd(){Ut&&(this._currentContainer=null)}recordPassStart(e){Ut&&(this._currentPass=e,this._initSummary())}recordPassEnd(){Ut&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){Ut&&(this._currentBrush=e)}recordBrushEnd(){Ut&&(this._currentBrush=null)}recordStart(e){if(Ut&&(0,o.pC)(this._ext)){if(this._entries.has(e)){const t=this._entries.get(e),i=this._ext.resultAvailable(t.query),s=this._ext.disjoint();if(i&&!s){const i=this._ext.getResult(t.query)/1e6;let s=0;if((0,o.pC)(this._timings.enqueue(i))){const e=this._timings.entries,t=e.length;let i=0;for(const s of e)i+=s;s=i/t}const r=i.toFixed(2),n=s?s.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${r} ms (${n} last 10 avg)\n${t.commandsLen} Commands (${t.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${r} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${r} (${n})`}for(const e of t.handles)e.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",e=>{t.commandsLen++,t.commands.push(e),e.isDrawCommand&&t.drawCommands++})),t.handles.push(this._events.on("summary",e=>{t.summaries.push(e)}))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){Ut&&(0,o.pC)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}var Nt=i(56372);const Wt=ae.Z.getLogger("esri.views.2d.engine.webgl.WebGLDriverTest");class Ht{constructor(e){this.svgAlwaysPremultipliesAlpha=!1,this._ignoresSamplerPrecision=null,this._context=e,(0,Nt.M)(e).then(e=>{this.svgAlwaysPremultipliesAlpha=!e})}get ignoresSamplerPrecision(){return(0,o.Wi)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Gt(this._context)),this._ignoresSamplerPrecision}}const qt=e=>new Ht(e),Gt=e=>{const t=new g.Z(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=new Uint8Array(4),s=new rt.Z(e,[0,0,1,0,0,1,1,1]),r=new P.$(e,"\nprecision highp float;\n\nattribute vec2 a_pos;\n\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\n\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",new Map([["a_pos",0]])),n=new b.Z(e,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));r.setUniform1i("u_texture",0),e.bindTexture(n,0);const a=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.useProgram(r);const{x:o,y:h,width:l,height:d}=e.getViewport();e.setViewport(0,0,1,1),s.draw(),e.setViewport(o,h,l,d),t.readPixels(0,0,1,1,6408,5121,i),r.dispose(),s.dispose(),t.dispose();const u=255!==i[0]||255!==i[1]||255!==i[2]||255!==i[3];return u&&Wt.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${i[0]}.${i[1]}.${i[2]}.${i[3]}]`),e.bindFramebuffer(a),u},jt={shaders:{vertexShader:(0,X.w)("stencil/stencil.vert"),fragmentShader:(0,X.w)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};var $t=i(39581),Xt=i(21965);class Kt extends T.W{constructor(e,t){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=(0,f.a)(),this._upperRight=(0,f.a)(),this._lowerLeft=(0,f.a)(),this._lowerRight=(0,f.a)(),this._mat2=(0,c.c)(),this._clipRendererInitialized=!1,this._supersampleScreenshots=!0,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:s=!0,stencil:l=!0,supersampleScreenshots:d=!0,contextOptions:u={}}=t;this._canvas=i;const p=(0,x.s)(i,1,{alpha:s,antialias:!1,depth:!0,stencil:l});this.context=new y.Z((0,o.pC)(p)?p:null,u),this.painter=new Bt(this.context,this),(0,a.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:C(this.state),pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new $t.T,renderingOptions:t.renderingOptions,requireFBO:!1,driverTestResult:qt(this.context),profiler:new Zt(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,h.A)({render:e=>this.renderFrame(e)}),this._taskHandle.pause(),this._supersampleScreenshots=d,this._lostWebGLContextHandle=(0,n.on)(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new r.Z("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,l.S1)(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(e),this.requestRender()}))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=C(this._state),this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:(0,p.c)()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=M.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const s of e)s.processRender(t);this.painter.renderLayers(i),t.drawPhase=M.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=M.jx.LABEL,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}if((0,a.Z)("esri-tiles-debug")){t.drawPhase=M.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(e){const{context:t}=this,{state:i,pixelRatio:s}=e;t.enforceState(),t.setClearDepth(1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT);const{size:r,rotation:n}=i,a=Math.round(r[0]*s),o=Math.round(r[1]*s);if(this._boundFBO=t.getBoundFramebufferObject(),!i.spatialReference||!(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable))return void(this._clipFrame=!1);const h=(0,d.t)(n),l=Math.abs(Math.cos(h)),c=Math.abs(Math.sin(h)),p=Math.round(a*l+o*c),f=Math.round(i.worldScreenWidth);if(p<=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===o||(this._clipFBO=new g.Z(t,{colorTarget:0,depthStencilTarget:3,width:a,height:o}));const _=(this.state.padding.left-this.state.padding.right)/2,v=(this.state.padding.bottom-this.state.padding.top)/2,y=.5*a,b=.5*o,w=1/a,x=1/o,T=f*s*.5,S=.5*(a*c+o*l),C=this._upperLeft,M=this._upperRight,R=this._lowerLeft,F=this._lowerRight;(0,m.s)(C,-T,-S),(0,m.s)(M,T,-S),(0,m.s)(R,-T,S),(0,m.s)(F,T,S),(0,u.i)(this._mat2),(0,u.t)(this._mat2,this._mat2,[y+_,b+v]),0!==n&&(0,u.r)(this._mat2,this._mat2,h),(0,m.t)(C,C,this._mat2),(0,m.t)(M,M,this._mat2),(0,m.t)(R,R,this._mat2),(0,m.t)(F,F,this._mat2);const P=this._clipData;P.set([2*R[0]*w-1,2*(o-R[1])*x-1,2*F[0]*w-1,2*(o-F[1])*x-1,2*C[0]*w-1,2*(o-C[1])*x-1,2*M[0]*w-1,2*(o-M[1])*x-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(P),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.useProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:i,b:s,a:r}=this.background.color;e.setClearColor(r*t/255,r*i/255,r*s/255,r)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}takeScreenshot(e,t){var i=this;return(0,s.Z)(function*(){const s=(0,Xt.$3)(e,i._supersampleScreenshots,i._state.padding),{framebufferWidth:r,framebufferHeight:n}=s,a=i.context,o=e.layers;let h=i.children;const l=i._state.clone();if(null!=e.rotation){const t=l.viewpoint;l.viewpoint.rotation=e.rotation,l.viewpoint=t}const d={...i._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:C(l),pixelRatio:s.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};o.length>0&&(h=[],o.forEach(e=>{const i=t.find(t=>t.layer.id===e.id);i&&"container"in i&&i.container&&h.push(i.container)}));const u=new g.Z(a,{colorTarget:0,depthStencilTarget:3,width:r,height:n}),c=a.getBoundFramebufferObject(),p=a.getViewport();a.bindFramebuffer(u),a.setViewport(0,0,r,n),i._renderChildren(h,d);const m=i._readbackScreenshot(s);a.bindFramebuffer(c),a.setViewport(p.x,p.y,p.width,p.height),i.requestRender();const f=i._ensureScreenshotEncodeCanvas();return(0,Xt.gH)(m,e,f,{flipY:!0,premultipliedAlpha:!0})})()}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}_readbackScreenshot(e){const{framebufferWidth:t,framebufferHeight:i,region:s,resample:r}=e,n=this.context.gl;if(r){const e=(0,Xt.r7)(t,i,this._ensureScreenshotEncodeCanvas());n.readPixels(0,0,t,i,6408,5121,new Uint8Array(e.data.buffer));const a=(0,Xt.r7)(s.width,s.height,this._ensureScreenshotEncodeCanvas());return(0,Xt.TT)(e,a,!0,r.region.x,i-(r.region.y+r.region.height),r.region.width,r.region.height)}{const e=(0,Xt.r7)(s.width,s.height,this._ensureScreenshotEncodeCanvas());return n.readPixels(s.x,i-(s.y+s.height),s.width,s.height,6408,5121,new Uint8Array(e.data.buffer)),e}}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:r}=e,n=s[0],a=s[1],o=Math.round(n*r),h=Math.round(a*r);t.width===o&&t.height===h||(t.width=o,t.height=h),i.width=n+"px",i.height=a+"px"}_initializeClipRenderer(e){if(this._clipRendererInitialized)return!0;const t=jt.attributes,i=(0,v.H)(e,jt);if(!i)return!1;const s=_.Z.createVertex(e,35040,32),r=new Uint16Array([0,1,2,2,1,3]),n=_.Z.createIndex(e,35044,r),a=new w.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:s},n);return this._clipStencilProgram=i,this._clipVBO=s,this._clipVAO=a,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof T.W)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}var Yt=i(8651),Qt=i(55328),Jt=i(1518),ei=i(962),ti=i(46942),ii=(i(47648),i(8680)),si=i(53934),ri=i(99140);class ni{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/1),s=Math.ceil(t/1);this._cols=i,this._rows=s,this._cells=ri.p.create(i*s)}insertMetrics(e){const t=this._hasCollision(e);return 0===t&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,s=0;e.save();do{const t=e.boundsCount;i+=t;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),r=e.boundsComputedAnchorY(i),n=e.boundsWidth(i)+2,a=e.boundsHeight(i)+2;switch(this._collide(t,r,n,a)){case 2:return 2;case 1:s++}}}while(e.peekId()===t&&e.next());return e.restore(),i===s?1:0}_collide(e,t,i,s){const r=e-i/2,n=t-s/2,a=r+i,o=n+s;if(a<0||o<0||r>this.width||n>this.height)return 1;const h=(0,si.uZ)(Math.floor(r/1),0,this._cols),l=(0,si.uZ)(Math.floor(n/1),0,this._rows),d=(0,si.uZ)(Math.ceil(a/1),0,this._cols),u=(0,si.uZ)(Math.ceil(o/1),0,this._rows);for(let c=l;c<=u;c++)for(let e=h;e<=d;e++){const t=this.getCellId(e,c);if(this.has(t))return 2}return 0}_mark(e,t,i,s){const r=e-i/2,n=t-s/2,a=r+i,o=n+s,h=(0,si.uZ)(Math.floor(r/1),0,this._cols),l=(0,si.uZ)(Math.floor(n/1),0,this._rows),d=(0,si.uZ)(Math.ceil(a/1),0,this._cols),u=(0,si.uZ)(Math.ceil(o/1),0,this._rows);for(let c=l;c<=u;c++)for(let e=h;e<=d;e++){const t=this.getCellId(e,c);this.set(t)}return!1}_markMetrics(e){const t=e.id;do{const t=e.boundsCount;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),s=e.boundsComputedAnchorY(i),r=e.boundsWidth(i)+2,n=e.boundsHeight(i)+2;this._mark(t,s,r,n)}}while(e.peekId()===t&&e.next())}}var ai=i(20891);const oi=Math.PI;function hi(e,t){switch(t.transformationType){case"additive":return function(e,t){return e+(li(t.minSize,e)||t.minDataValue)}(e,t);case"constant":return function(e,t){const i=e.stops;let s=i&&i.length&&i[0].size;return null==s&&(s=e.minSize),li(s,t)}(t,e);case"clamped-linear":return function(e,t){const i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),s=li(t.minSize,e),r=li(t.maxSize,e);return e<=t.minDataValue?s:e>=t.maxDataValue?r:s+i*(r-s)}(e,t);case"proportional":return function(e,t){const i=e/t.minDataValue,s=li(t.minSize,e),r=li(t.maxSize,e);let n=null;return n=i*s,(0,si.uZ)(n,s,r)}(e,t);case"stops":return function(e,t){const[i,s,r]=function(e,t){if(!t)return;let i=0,s=t.length-1;return t.some((t,r)=>e<t?(s=r,!0):(i=r,!1)),[i,s,(e-t[i])/(t[s]-t[i])]}(e,t.cache.ipData);if(i===s)return li(t.stops[i].size,e);{const n=li(t.stops[i].size,e);return n+(li(t.stops[s].size,e)-n)*r}}(e,t);case"real-world-size":return function(e,t){const i=ai.a[t.valueUnit],s=li(t.minSize,e),r=li(t.maxSize,e),{valueRepresentation:n}=t;let a=null;return a="area"===n?2*Math.sqrt(e/oi)/i:"radius"===n||"distance"===n?2*e/i:e/i,(0,si.uZ)(a,s,r)}(e,t);case"identity":return e;case"unknown":return null}}function li(e,t){return"number"==typeof e?e:hi(t,e)}const di=255;function ui(e,t){const i=[];e.forEachTile(e=>i.push(e)),i.sort((e,t)=>e.instanceId-t.instanceId),i.forEach(e=>{(0,o.pC)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())})}function ci(e){return t=>(0,he.F2)(hi(t,e))}function pi(e,t){if(!function(e){return"feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type}(t))return;const i=t.layer.geometryType,s=!function(e){for(const i of e){var t;const e="featureReduction"in i&&"cluster"===(null==(t=i.featureReduction)?void 0:t.type)&&i.featureReduction,s=[...i.labelingInfo||[],...e.labelingInfo||[]];if(i.labelsVisible&&s.length&&s.some(e=>"none"===e.deconflictionStrategy))return!0}return!1}("subtype-group"===t.layer.type?t.layer.sublayers.items:[t.layer]),r={};if("subtype-group"!==t.layer.type){if("heatmap"===t.layer.renderer.type)return;const e=function(e){const t="visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if("size"===i.type)return ci(i);return null}(t.layer.renderer);r[0]=e}const n=t.tileRenderer;(0,o.Wi)(n)||e.push({tileRenderer:n,vvEvaluators:r,deconflictionEnabled:s,geometryType:i,visible:t.layer.visible})}class mi{run(e,t,i){const s=[];for(let r=e.length-1;r>=0;r--)pi(s,e[r]);this._transformMetrics(s,t),this._runCollision(s,t,i)}_runCollision(e,t,i){const[s,r]=t.state.size,n=new ni(s*t.pixelRatio,r*t.pixelRatio);for(const{tileRenderer:a,deconflictionEnabled:o,visible:h}of e){const e=a.featuresView.attributeView;o?h?(this._prepare(a),this._collideVisible(n,a,i),this._collideInvisible(n,a)):ui(a,(t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,di)}):ui(a,(t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,0)})}}_isFiltered(e,t,i){const s=t.getFilterFlags(e);return!((!i.hasFilter||s&ue.Zd)&&(!i.effect||i.effect.excludedLabelsVisible||s&ue.iV))}_prepare(e){const t=e.featuresView.attributeView,i=new Set;ui(e,(s,r)=>{for(;r.nextId();)i.has(r.id)||(i.add(r.id),this._isFiltered(r.id,t,e.layerView)?t.setLabelMinZoom(r.id,254):0!==t.getLabelMinZoom(r.id)?t.setLabelMinZoom(r.id,di):t.setLabelMinZoom(r.id,0))})}_collideVisible(e,t,i){const s=t.featuresView.attributeView,r=new Set;ui(t,(t,n)=>{for(;n.nextId();)if(!r.has(n.id))if(t.key.level===i){if(0===s.getLabelMinZoom(n.id))switch(e.insertMetrics(n)){case 1:break;case 2:s.setLabelMinZoom(n.id,254),r.add(n.id);break;case 0:s.setLabelMinZoom(n.id,0),r.add(n.id)}}else s.setLabelMinZoom(n.id,254)})}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;ui(t,(t,r)=>{for(;r.nextId();)if(!s.has(r.id)&&i.getLabelMinZoom(r.id)===di)switch(e.insertMetrics(r)){case 1:break;case 2:i.setLabelMinZoom(r.id,di),s.add(r.id);break;case 0:i.setLabelMinZoom(r.id,0),s.add(r.id)}})}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:s,vvEvaluators:r}of e)ui(i,(e,n)=>{const a=i.featuresView.attributeView,h=e.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const l=h[4],d=h[5],u="polyline"===s;for(;n.next();){const e=n.boundsCount,i=n.anchorX,s=n.anchorY;let c=n.size;const p=r[0];if((0,o.pC)(p)){const e=p(a.getVVSize(n.id));c=isNaN(e)||null==e||e===1/0?c:e}const m=n.directionX*(c/2),f=n.directionY*(c/2);for(let r=0;r<e;r++){let e=i,a=n.anchorY;if(u){let i=e+n.boundsX(r)+m,s=a+n.boundsY(r)+f;t.state.rotation?(i=h[0]*i+h[2]*s+h[4],s=h[1]*i+h[3]*s+h[5]):(i+=l,s+=d),n.setBoundsComputedAnchorX(r,Math.floor(i)),n.setBoundsComputedAnchorY(r,Math.floor(s))}else{t.state.rotation?(e=h[0]*i+h[2]*s+h[4],a=h[1]*i+h[3]*s+h[5]):(e+=l,a+=d);const o=e+n.boundsX(r)+m,u=a+n.boundsY(r)+f;n.setBoundsComputedAnchorX(r,o),n.setBoundsComputedAnchorY(r,u)}}}})}}const fi=ae.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let _i=class extends((0,Jt.p)(Qt.Z)){constructor(e){super(e),this._applyVisibilityPassThrottled=(0,ei.P)(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new mi}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(e){this._applyVisibilityPassThrottled(e)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}_applyVisibilityPass(e){try{const t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,e,t)}catch(t){fi.error(new r.Z("mapview-labeling","Encountered an error during label decluttering",t))}}};(0,Yt._)([(0,ti.Cb)()],_i.prototype,"updateRequested",void 0),(0,Yt._)([(0,ti.Cb)({readOnly:!0})],_i.prototype,"updateParameters",void 0),(0,Yt._)([(0,ti.Cb)()],_i.prototype,"updating",null),(0,Yt._)([(0,ti.Cb)()],_i.prototype,"view",void 0),_i=(0,Yt._)([(0,ii.j)("esri.views.2d.layers.labels.LabelManager")],_i);var gi=_i,vi=i(61789),yi=i(64713),bi=i(68367),wi=i(38975),xi=i(42467);const Ti="Shift";let Si=class extends Qt.Z{constructor(e){super(e),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(e){this._handles&&this._handles.forEach(e=>{e.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",[Ti],e=>this._handleDrag(e,1),xi.f.INTERNAL),e.on("drag",[Ti,"Ctrl"],e=>this._handleDrag(e,-1),xi.f.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(e,t,i,s){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=s,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(e,t,i,s,r){const n=this.view,a=n.toMap((0,he.vW)(e+.5*i,t+.5*s));let o=Math.max(i/n.width,s/n.height);-1===r&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(e,t,i,s){const r=this._boxShape;r.setAttributeNS(null,"x",""+e),r.setAttributeNS(null,"y",""+t),r.setAttributeNS(null,"width",""+i),r.setAttributeNS(null,"height",""+s),r.setAttributeNS(null,"class","esri-zoom-box__outline")}_updateBackground(e,t,i,s){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,s,this.view.width,this.view.height))}_createContainer(){const e=document.createElement("div");e.className="esri-zoom-box__container",this.view.root.appendChild(e),this._container=e}_createOverlay(){const e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class","esri-zoom-box__overlay-background");const s=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class","esri-zoom-box__overlay"),r.appendChild(i),r.appendChild(s),this._container.appendChild(r),this._backgroundShape=i,this._boxShape=s,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(e,t,i,s,r,n){const a=e+i,o=t+s;return"M 0 0 L "+r+" 0 L "+r+" "+n+" L 0 "+n+" ZM "+e+" "+t+" L "+e+" "+o+" L "+a+" "+o+" L "+a+" "+t+" Z"}_handleDrag(e,t){const i=e.x,s=e.y,r=e.origin.x,n=e.origin.y;let a,o,h,l;switch(i>r?(a=r,h=i-r):(a=i,h=r-i),s>n?(o=n,l=s-n):(o=s,l=n-s),e.action){case"start":this._start();break;case"update":this._update(a,o,h,l);break;case"end":this._end(a,o,h,l,t)}e.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:e,y:t,width:i,height:s}=this._box;this._updateBox(e,t,i,s),this._updateBackground(e,t,i,s),this._rafId=requestAnimationFrame(this._redraw)}};(0,Yt._)([(0,ti.Cb)()],Si.prototype,"navigation",void 0),(0,Yt._)([(0,ti.Cb)()],Si.prototype,"view",null),Si=(0,Yt._)([(0,ii.j)("esri.views.2d.navigation.ZoomBox")],Si);var Ci=Si,Mi=(i(42851),i(32589)),Ri=i(61001);class Fi{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}updateDelta(e){this.filteredDelta=this.hasFilteredDelta?(1-this.gain)*this.filteredDelta+this.gain*e:e}}class Pi{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class zi extends Pi{constructor(e,t,i,s,r){super(e,t,i),this.sceneVelocity=s,this.direction=r}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class Di{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new Fi(.6),this.screen=[new Fi(.4),new Fi(.4)],this.scene=[new Fi(.6),new Fi(.6),new Fi(.6)],this.tmpDirection=(0,Ri.c)()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){(0,Mi.s)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=(0,Mi.l)(this.tmpDirection);return s>0&&(0,Mi.a)(this.tmpDirection,this.tmpDirection,1/s),new zi(e,t,i,s/this.time.filteredDelta,this.tmpDirection)}}let Oi=class extends Qt.Z{constructor(e){super(e),this.animationTime=0,this.momentumEstimator=new Di(500,6,.92),this.momentum=null,this.tmpMomentum=(0,Ri.c)(),this.momentumFinished=!1,this.viewpoint=new bi.Z({targetGeometry:new wi.Z,scale:0,rotation:0}),this.watch("momentumFinished",e=>{e&&this.navigation.stop()})}begin(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}update(e,t){this.addToEstimator(t);let i=t.center.x,s=t.center.y;const r=this.previousDrag;i=r?r.center.x-i:-i,s=r?s-r.center.y:s,e.viewpoint=(0,S.Rx)(this.viewpoint,e.viewpoint,[i||0,s||0]),this.previousDrag=t}end(e,t){this.addToEstimator(t),this.momentum=e.navigation.momentumEnabled?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this.previousDrag=null,this.navigation.end()}addToEstimator(e){const t=e.center.x,i=e.center.y,s=(0,he.s1)(-t,i),r=(0,Ri.f)(-t,i,0);this.momentumEstimator.add(s,r,.001*e.timestamp)}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,(t,i)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const s=.001*i;if(!this.momentumFinished){const i=this.momentum.valueDelta(this.animationTime,s);(0,Mi.a)(this.tmpMomentum,this.momentum.direction,i),(0,S.Rx)(t,t,this.tmpMomentum),e.constraints.constrainByGeometry(t)}this.animationTime+=s})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,Yt._)([(0,ti.Cb)()],Oi.prototype,"momentumFinished",void 0),(0,Yt._)([(0,ti.Cb)()],Oi.prototype,"viewpoint",void 0),(0,Yt._)([(0,ti.Cb)()],Oi.prototype,"navigation",void 0),Oi=(0,Yt._)([(0,ii.j)("esri.views.2d.navigation.actions.Pan")],Oi);var Ii=Oi;class Ei{constructor(e=2.5,t=.01,i=.95,s=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=s,this.enabled=!0,this.value=new Fi(.8),this.time=new Fi(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,si.uZ)(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new Pi(e,t,i)}}class Bi extends Ei{constructor(e=3,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){if(this.value.hasLastValue){const t=this.value.lastValue;let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=t+i}super.add(e,t)}}class Ai extends Pi{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),s=super.value(e+t)-i;return Math.exp(s)}}class Vi extends Ei{constructor(e=2.5,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Ai(e,t,i)}}let Li=class extends Qt.Z{constructor(e){super(e),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new Bi(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new Vi,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new bi.Z({targetGeometry:new wi.Z,scale:0,rotation:0}),this.watch("_momentumFinished",e=>{e&&this.navigation.stop()})}begin(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);const i=t.angle,s=t.radius,r=t.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),a=Math.abs(s-this._startRadius),o=this._startRadius/s;if(this._previousRadius){const h=s/this._previousRadius;let l=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=h>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),null===this._zoomOnly||this._zoomOnly?l=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([r.x,r.y],1/h,l,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=s,this._previousCenter=r}end(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}addToRotateEstimator(e,t){this._rotationMomentumEstimator.add(e,.001*t)}addToZoomEstimator(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}canZoomIn(e){const t=e.constraints.effectiveMaxScale;return 0===t||e.scale>t}canZoomOut(e){const t=e.constraints.effectiveMinScale;return 0===t||e.scale<t}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,(t,i)=>{const s=!this.canZoomIn(e)&&this._zoomDirection>1||!this.canZoomOut(e)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*i;if(this._momentumFinished=r&&n,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let s=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const r=(0,f.a)(),n=(0,f.a)();if(this._previousCenter){(0,m.s)(r,this._previousCenter.x,this._previousCenter.y),(0,S.Dq)(n,e.size,e.padding),(0,m.i)(r,r,n);const{constraints:a,scale:o}=e,h=o*s;s<1&&!a.canZoomInTo(h)?(s=o/a.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):s>1&&!a.canZoomOutTo(h)&&(s=o/a.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,S.UZ)(t,e.viewpoint,s,i,r,e.size),e.constraints.constrainByGeometry(t)}}this._animationTime+=a})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,Yt._)([(0,ti.Cb)()],Li.prototype,"_momentumFinished",void 0),(0,Yt._)([(0,ti.Cb)()],Li.prototype,"viewpoint",void 0),(0,Yt._)([(0,ti.Cb)()],Li.prototype,"navigation",void 0),Li=(0,Yt._)([(0,ii.j)("esri.views.2d.navigation.actions.Pinch")],Li);var ki=Li;const Ui=(0,f.a)(),Zi=(0,f.a)();let Ni=class extends Qt.Z{constructor(e){super(e),this._previousCenter=(0,f.a)(),this.viewpoint=new bi.Z({targetGeometry:new wi.Z,scale:0,rotation:0})}begin(e,t){this.navigation.begin(),(0,m.s)(this._previousCenter,t.center.x,t.center.y)}update(e,t){const{state:{size:i,padding:s}}=e;(0,m.s)(Ui,t.center.x,t.center.y),(0,S.ni)(Zi,i,s),e.viewpoint=(0,S.$H)(this.viewpoint,e.state.paddedViewState.viewpoint,(0,S.dI)(Zi,this._previousCenter,Ui)),(0,m.c)(this._previousCenter,Ui)}end(){this.navigation.end()}};(0,Yt._)([(0,ti.Cb)()],Ni.prototype,"viewpoint",void 0),(0,Yt._)([(0,ti.Cb)()],Ni.prototype,"navigation",void 0),Ni=(0,Yt._)([(0,ii.j)("esri.views.2d.actions.Rotate")],Ni);var Wi=Ni;const Hi=new bi.Z({targetGeometry:new wi.Z}),qi=[0,0];let Gi=class extends Qt.Z{constructor(e){super(e),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Ii({navigation:this}),this.rotate=new Wi({navigation:this}),this.pinch=new ki({navigation:this}),this.zoomBox=new Ci({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}zoom(e,t=this._getDefaultAnchor()){var i=this;return(0,s.Z)(function*(){if(i.stop(),i.begin(),i.view.constraints.snapToZoom&&i.view.constraints.effectiveLODs)return e<1?i.zoomIn(t):i.zoomOut(t);i.setViewpoint(t,e,0,[0,0])})()}zoomIn(e){var t=this;return(0,s.Z)(function*(){const i=t.view,s=i.constraints.snapToNextScale(i.scale);return t._zoomToScale(s,e)})()}zoomOut(e){var t=this;return(0,s.Z)(function*(){const i=t.view,s=i.constraints.snapToPreviousScale(i.scale);return t._zoomToScale(s,e)})()}setViewpoint(e,t,i,s){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,s),this.end()}setViewpointImmediate(e,t=0,i=[0,0],s=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,e,t,i)}continousRotateClockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,e=>{(0,S.$H)(e,e,-1)})}continousRotateCounterclockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,e=>{(0,S.$H)(e,e,1)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(e){const t=this.get("view.viewpoint");this.animationManager.animateContinous(t,t=>{(0,S.Rx)(t,t,e),this.view.constraints.constrainByGeometry(t)})}_startTimer(e){return null!==this._endTimer||(this._endTimer=setTimeout(()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<250?this._endTimer=this._startTimer(e):this._set("interacting",!1)},e)),this._endTimer}_getDefaultAnchor(){const{size:e,padding:{left:t,right:i,top:s,bottom:r}}=this.view;return qi[0]=.5*(e[0]-i+t),qi[1]=.5*(e[1]-r+s),qi}_zoomToScale(e,t=this._getDefaultAnchor()){var i=this;return(0,s.Z)(function*(){const{view:s}=i,{constraints:r,scale:n,viewpoint:a,size:o,padding:h}=s,l=r.canZoomInTo(e),d=r.canZoomOutTo(e);if(!(e<n&&!l||e>n&&!d))return(0,S.gG)(Hi,a,e/n,0,t,o,h),r.constrainByGeometry(Hi),s.goTo(Hi,{animate:!0})})()}_scaleRotateTranslateViewpoint(e,t,i,s,r){const{view:n}=this,{size:a,padding:o,constraints:h,scale:l,viewpoint:d}=n,u=l*i,c=h.canZoomInTo(u),p=h.canZoomOutTo(u);return(i<1&&!c||i>1&&!p)&&(i=1),(0,S.Rx)(d,d,r),(0,S.gG)(e,d,i,s,t,a,o),h.constrainByGeometry(e)}};(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"animationManager",void 0),(0,Yt._)([(0,ti.Cb)({type:Boolean,readOnly:!0})],Gi.prototype,"interacting",void 0),(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"pan",void 0),(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"pinch",void 0),(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"rotate",void 0),(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"view",void 0),(0,Yt._)([(0,ti.Cb)()],Gi.prototype,"zoomBox",void 0),Gi=(0,Yt._)([(0,ii.j)("esri.views.2d.navigation.MapViewNavigation")],Gi);var ji=Gi,$i=i(43435),Xi=i(57319),Ki=i(66863);const Yi={shaders:{vertexShader:(0,X.w)("magnifier/magnifier.vert"),fragmentShader:(0,X.w)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var Qi=i(95637);function Ji(){return(Ji=(0,s.Z)(function*(e){const t=i.e(729).then(i.bind(i,10729)),s=i.e(4336).then(i.bind(i,14336)),r=(0,Qi.t)((yield t).default,{signal:e}),n=(0,Qi.t)((yield s).default,{signal:e}),a={mask:yield r,overlay:yield n};return(0,oe.k_)(e),a})).apply(this,arguments)}class es extends Ki.s{constructor(){super(),this._handles=new $i.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,l.S1)(e,"version",()=>{this.visible=e.visible&&(0,o.pC)(e.position)&&e.size>0,this.requestRender()}),e.watch(["mask","overlay"],()=>this._reloadResources()),e.watch("size",()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:(0,p.c)()}}doRender(e){var t;const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==M.jx.MAP||!this._canRender())return;this._updateResources(e);const s=this._magnifier;if((0,o.Wi)(s.position))return;const r=e.pixelRatio,n=s.size*r,a=Math.ceil(1/s.factor*n);this._readbackTexture.resize(a,a);const{size:h}=e.state,l=r*h[0],d=r*h[1],u=.5*a,c=.5*a,p=(0,si.uZ)(r*s.position.x,u,l-u-1),m=(0,si.uZ)(d-r*s.position.y,c,d-c-1);i.setBlendingEnabled(!0);const f=p-u,_=m-c,g=this._readbackTexture;i.bindTexture(g,0),i.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,f,_,a,a,0);const v=null==(t=this.background)?void 0:t.color,y=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],b=(p+s.offset.x*r)/l*2-1,w=(m-s.offset.y*r)/d*2-1,x=n/l*2,T=n/d*2,S=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(S),S.setUniform4fv("u_background",y),S.setUniform1i("u_readbackTexture",0),S.setUniform1i("u_overlayTexture",6),S.setUniform1i("u_maskTexture",7),S.setUniform4f("u_drawPos",b,w,x,T),S.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),S.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const t=(0,o.pC)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,o.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,oe.vr)(function(){var r=(0,s.Z)(function*(s){const r=(0,o.Wi)(t)||(0,o.Wi)(i)?function(e){return Ji.apply(this,arguments)}(s):null,n=(0,o.pC)(t)?(0,ne.default)(t,{responseType:"image",signal:s}).then(e=>e.data):r.then(e=>e.mask),a=(0,o.pC)(i)?(0,ne.default)(i,{responseType:"image",signal:s}).then(e=>e.data):r.then(e=>e.overlay),[h,l]=yield Promise.all([n,a]);e.mask=h,e.overlay=l,e._disposeRenderResources(),e.requestRender()});return function(e){return r.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,o.O3)(this._readbackTexture),this._overlayTexture=(0,o.O3)(this._overlayTexture),this._maskTexture=(0,o.O3)(this._maskTexture),this._vertexArrayObject=(0,o.O3)(this._vertexArrayObject),this._program=(0,o.O3)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(e){return(0,v.H)(e,Yi)}(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new w.Z(t,Yi.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:_.Z.createVertex(t,35044,s)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new b.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!(0,Xi.zd)(this.overlay.src)||!e.driverTestResult.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new b.Z(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const r=1/this._magnifier.factor;this._readbackTexture=new b.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(r*i),height:Math.ceil(r*i)})}}}}]);
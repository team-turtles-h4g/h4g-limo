(self.webpackChunkh4g_limo=self.webpackChunkh4g_limo||[]).push([[9626],{59626:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>et});var n=r(16304),i=r(8651),s=r(82772),a=r(47059),o=r(2747),l=r(54704),u=r(67372),f=r(98154),c=r(46942),d=(r(12131),r(47648)),p=r(18419),m=r(28062),h=r(41460),y=r(8680),g=r(3523),x=r(68141),v=r(46642),I=(r(42851),r(93668)),b=r(13585),w=r(73507),C=r(1295),_=r(17788),T=r(98918),S=r(15172),R=r(5052),k=r(41186),P=r(81387),M=r(69925),F=r(95046),O=r(2379);const Z=p.Z.getLogger("esri.layers.mixins.ImageryTileMixin"),D=e=>{let t=class extends e{constructor(){super(...arguments),this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.fullExtent=null,this.interpolation="nearest",this.raster=null,this.rasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.tileInfo=null,this.symbolizer=null}set multidimensionalDefinition(e){this.raster&&(this._sliceId=this.raster.getSliceIndex(e)),this._set("multidimensionalDefinition",e)}set url(e){this._set("url",(0,C.Nm)(e,Z))}set renderer(e){this._set("renderer",e),this.updateRenderer()}convertVectorFieldData(e,t){var r=this;return(0,n.Z)(function*(){if((0,l.Wi)(e))return null;const n=r._rasterJobHandler.instance,i=r.rasterInfo.dataType;return n?n.convertVectorFieldData({pixelBlock:e,dataType:i},t):(0,k.KC)(e,i)})()}updateRenderer(){var e=this;return(0,n.Z)(function*(){if(!e.loaded)return;if(JSON.stringify(e._cachedRendererJson)===JSON.stringify(e.renderer))return;const t=e._rasterJobHandler.instance;t&&(e.symbolizer.rendererJSON=(0,P.ol)(e.renderer.toJSON()),e.symbolizer.bind(),yield t.updateSymbolizer(e.symbolizer),e._cachedRendererJson=e.renderer.toJSON())})()}applyRenderer(e,t){var r=this;return(0,n.Z)(function*(){const n=e&&e.pixelBlock;if(!((0,l.pC)(n)&&n.pixels&&n.pixels.length>0))return null;let i;yield r.updateRenderer();const s=r._rasterJobHandler.instance,{bandIds:a}=r;return i=s?yield s.symbolize({...e,simpleStretchParams:t,bandIds:a}):r.symbolizer.symbolize({...e,simpleStretchParams:t,bandIds:a}),i})()}getTileUrl(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?`${this.url}/tile/${e}/${t}/${r}`:""}getCompatibleTileInfo(e,t,r=!1){if(!this.loaded)return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;const n=(0,w.C5)(e);return R.Z.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}getCompatibleFullExtent(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}fetchTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){if(i.requestAsImageElement){const n=s.getTileUrl(e,t,r);return(0,I.default)(n,{responseType:"image",query:{sliceId:s._sliceId,...s.refreshParameters,...s.raster.ioConfig.customFetchParameters},signal:i.signal}).then(e=>e.data)}return yield s._initJobHandler(),s.multidimensionalDefinition&&(i={multidimensionalDefinition:s.multidimensionalDefinition,sliceId:s._sliceId,buffer:"raster-shaded-relief"===s.renderer.type?{cols:1,rows:1}:null,...i}),s.raster.fetchTile(e,t,r,i)})()}fetchPixels(e,t,r,i){var s=this;return(0,n.Z)(function*(){return yield s._initJobHandler(),s.multidimensionalDefinition&&(i={multidimensionalDefinition:s.multidimensionalDefinition,sliceId:s._sliceId,...i}),s.raster.fetchPixels(e,t,r,i)})()}identify(e,t={}){return this.multidimensionalDefinition&&!t.multidimensionalDefinition&&(t={...t,multidimensionalDefinition:this.multidimensionalDefinition}),this.raster.identify(e,t)}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}hasStandardTime(){var e;const t=this.rasterInfo.multidimensionalInfo;if(!(0,l.pC)(t)||"standard-time"!==this.rasterInfo.dataType)return!1;const r=null==(e=this.multidimensionalDefinition[0])?void 0:e.variableName;return t.variables.some(e=>e.name===r&&e.dimensions.some(e=>"StdTime"===e.name))}getStandardTimeValue(e){return new Date(24*(e-25569)*3600*1e3).toString()}_configDefaultSettings(){this._configDefaultInterpolation(),this._configDefaultSlice(),this._configDefaultRenderer()}_initJobHandler(){if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;const e=new S.Z;return this._rasterJobHandler.connectionPromise=e.initialize().then(()=>{this._rasterJobHandler.instance=e,this.raster.rasterJobHandler=e,this.renderer&&this.updateRenderer()}).catch(()=>null),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null}_configDefaultInterpolation(){if(null==this.interpolation){var e;const t=(0,P.In)(this.rasterInfo,this.raster.tileType,null==(e=this.sourceJSON)?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}_configDefaultSlice(){const{multidimensionalInfo:e}=this.raster.rasterInfo;if((0,l.pC)(e)){if(!this.multidimensionalDefinition){const t=e.variables[0],r=[];t.dimensions.forEach(e=>{r.push(new T.Z({variableName:t.name,dimensionName:e.name,values:e.hasRegularIntervals?e.extent[0]:e.values[0],isSlice:!0}))}),this.multidimensionalDefinition=r}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}}_configDefaultRenderer(){const e=this.raster.rasterInfo;var t,r;this.bandIds||(this.bandIds=(0,P.YD)(e)),this.renderer||(this.renderer=(0,P.Ob)(e,{bandIds:this.bandIds,variableName:null==(t=this.multidimensionalDefinition)||null==(r=t[0])?void 0:r.variableName})),this.symbolizer?(this.symbolizer.rendererJSON=(0,P.ol)(this.renderer.toJSON()),this.symbolizer.rasterInfo=e):this.symbolizer=new M.Z({rendererJSON:this.renderer.toJSON(),rasterInfo:e}),this.symbolizer.bind()||Z.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")}};return(0,i._)([(0,c.Cb)()],t.prototype,"_cachedRendererJson",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"_sliceId",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"_compatibleFullExtent",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"_rasterJobHandler",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"bandIds",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"copyright",void 0),(0,i._)([(0,c.Cb)({type:F.Z}),(0,b.B)("rasterInfo.extent")],t.prototype,"fullExtent",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"interpolation",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"ioConfig",void 0),(0,i._)([(0,c.Cb)({type:[T.Z]})],t.prototype,"multidimensionalDefinition",null),(0,i._)([(0,c.Cb)()],t.prototype,"raster",void 0),(0,i._)([(0,c.Cb)({readOnly:!0}),(0,b.B)("raster.rasterInfo")],t.prototype,"rasterInfo",void 0),(0,i._)([(0,c.Cb)()],t.prototype,"sourceJSON",void 0),(0,i._)([(0,c.Cb)({type:O.Z}),(0,b.B)("rasterInfo.spatialReference")],t.prototype,"spatialReference",void 0),(0,i._)([(0,c.Cb)({type:R.Z}),(0,b.B)("rasterInfo.storageInfo.tileInfo")],t.prototype,"tileInfo",void 0),(0,i._)([(0,c.Cb)(_.HQ)],t.prototype,"url",null),(0,i._)([(0,c.Cb)({types:a.dr})],t.prototype,"renderer",null),(0,i._)([(0,c.Cb)()],t.prototype,"symbolizer",void 0),t=(0,i._)([(0,y.j)("esri.layers.ImageryTileMixin")],t),t};var B=r(83727),z=r(20174),E=r(69265),N=r(37001),H=r(23535),A=r(22551),L=r(92952),J=r(4791),W=r(49533),q=r(19339),j=r(2410),U=r(86170),G=r(70713),V=r(98694),$=r(38975);let Y=class extends((0,q.v)(W.wq)){constructor(){super(...arguments),this.rasterJobHandler=null,this.datasetName=null,this.datasetFormat=null,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}init(){var e=this;return(0,n.Z)(function*(){const t=(0,V.zD)();e.addResolvingPromise(t),yield e.when()})()}normalizeCtorArgs(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:R.Z.create(),...e.ioConfig}}),e}set url(e){this._set("url",(0,C.Nm)(e,p.Z.getLogger(this.declaredClass)))}open(e){return(0,n.Z)(function*(){throw new o.Z("BaseRaster:open-not-implemented","open() is not implemented")})()}fetchTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){const{tileInfo:n}=i,a=n.lodAt(e),o=s.getTileExtent({x:a.resolution,y:a.resolution},t,r,n.origin,n.spatialReference,n.size);return i=s._getRequestOptionsWithSliceId(i),s.fetchPixels(o,n.size[0],n.size[1],i)})()}identify(e,t={}){var r=this;return(0,n.Z)(function*(){t=r._getRequestOptionsWithSliceId(t);const{spatialReference:n,extent:i}=r.rasterInfo,{datumTransformation:s}=t;let a=(0,V.nF)(e,n,s);if(!i.intersects(a))return{location:a,value:null};if((0,l.pC)(r.rasterInfo.transform)){const e=r.rasterInfo.transform.inverseTransform(a);if(!r.rasterInfo.nativeExtent.intersects(e))return{location:e,value:null};a=e}let o=0;if(t.srcResolution)o=(0,V.kr)(t.srcResolution,r.rasterInfo,r.ioConfig.sampling).pyramidLevel;else if(o=yield r.computeBestPyramidLevelForLocation(e,t),null==o)return{location:a,value:null};const u=r.identifyPixelLocation(a,o,null);if(null===u)return{location:a,value:null};const{row:f,col:c,rowOffset:d,colOffset:p}=u,m=(0,j.Rq)(r.url,t.sliceId),h=`${o}/${f}/${c}`;let y=(0,j.Qg)(m,null,h);(0,l.Wi)(y)&&(y=r.fetchRawTile(o,f,c,t),(0,j.gX)(m,null,h,y));const g=yield y;if((0,l.Wi)(g)||!g.pixels||0===g.pixels.length)return{location:a,value:null};const x=d*r.rasterInfo.storageInfo.blockHeight+p,v=!g.mask||g.mask[x]?g.pixels.map(e=>e[x]):null,I=r.rasterInfo.dataType;return("vector-magdir"===I||"vector-uv"===I)&&(null==v?void 0:v.length)>1?{location:a,value:v,magdirValue:"vector-magdir"===I?[v[0],v[1]]:(0,k.Tg)([v[0],v[1]]),pyramidLevel:o}:{location:a,value:v,pyramidLevel:o}})()}fetchPixels(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){e=(0,V.kZ)(e);const n=(0,V.Hq)(e),a=s.rasterInfo.spatialReference,o=!e.spatialReference.equals(a),{datumTransformation:u}=i,f=new $.Z({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),c=i.srcResolution||(o?(0,V.VO)(f,a,e,u):f);if(!c)return null;const{pyramidLevel:d,pyramidResolution:p,excessiveReading:m}=(0,V.kr)(c,s.rasterInfo,s.ioConfig.sampling);if(m)return null;const h=s.rasterInfo.storageInfo;let y=o?(0,V.tB)(e,a,u):e;const g=(0,l.Wg)(s.rasterInfo.transform);if(g&&(y=g.inverseTransform(y)),null==y)return null;const x={x:Math.floor((y.xmin-h.origin.x)/p.x+.1),y:Math.floor((h.origin.y-y.ymax)/p.y+.1)},v=Math.ceil((y.xmax-y.xmin)/p.x-.1),I=Math.ceil((y.ymax-y.ymin)/p.y-.1);if(v/t>8||I/r>8||n>=2)return null;const b=yield s.fetchRawPixels(d,x,{width:v,height:I,wrapCount:n},i);if(!b)return null;const w=d>0?h.pyramidBlockWidth:h.blockWidth,C=d>0?h.pyramidBlockHeight:h.blockHeight;if(!o&&w===v&&C===I&&x.x%w==0&&x.y%C==0&&1===b.pixelBlocks.length&&w===t&&C===r&&c.x===f.x&&c.y===f.y)return{extent:e,srcExtent:y,pixelBlock:b.pixelBlocks[0]};const _=(0,V.Qp)(e,b.extent,f,u,g,n>0);let T;const S=!i.requestRawData,R={rows:_.spacing[0],cols:_.spacing[1]},k=(0,l.Wg)(s._getRasterTileAlignmentInfo(d,b.extent.xmin)),{pixelBlocks:P,mosaicSize:M,isPartiallyFilled:F}=b;if(s.rasterJobHandler)T=yield s.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:P,srcMosaicSize:M,destDimension:S?{width:t,height:r}:null,coefs:S?_.coefficients:null,sampleSpacing:S?R:null,interpolation:i.interpolation,alignmentInfo:k},i);else{const e=(0,G.us)(P,M,null,null,k);T=S?(0,G.Uk)(e,{width:t,height:r},_.coefficients,R,i.interpolation):e}return i.requestRawData?{srcExtent:y,pixelBlock:T,transformGrid:_,extent:e,isPartiallyFilled:F}:{srcExtent:y,extent:e,pixelBlock:T}})()}fetchRawPixels(e,t,r,i){var s=this;return(0,n.Z)(function*(){const{origin:n,blockBoundary:a}=s.rasterInfo.storageInfo,{blockWidth:o,blockHeight:u}=s.getBlockWidthHeight(e);let{x:f,y:c}=t,{width:d,height:p,wrapCount:m}=r;const h=(0,l.Wg)(s._getRasterTileAlignmentInfo(e,0));i.buffer&&(f-=i.buffer.cols,c-=i.buffer.rows,d+=2*i.buffer.cols,p+=2*i.buffer.rows);const y=Math.floor(f/o),g=Math.floor(c/u),x=Math.floor((f+d-1)/o),v=Math.floor((c+p-1)/u),I=a[e];if(!I)return null;const{minRow:b,minCol:w,maxCol:C,maxRow:_}=I;if(v<b||x<w||g>_||y>C)return null;const T=new Array;let S=!1;const R=null==s.ioConfig.allowPartialFill?i.allowPartialFill:s.ioConfig.allowPartialFill;for(let t=g;t<=v;t++)for(let r=y;r<=x;r++){const n=0===m||null==h||r<h.worldColumnCountFromOrigin?r:r%h.worldColumnCountFromOrigin-h.originColumnOffset;if(t>=b&&n>=w&&_>=t&&C>=n){const r=s._fetchRawTile(e,t,n,i);T.push(R?new Promise(e=>{r.then(t=>e(t)).catch(()=>{S=!0,e(null)})}):r)}else T.push(null)}if(0===T.length)return null;const k=yield Promise.all(T),P={height:(v-g+1)*u,width:(x-y+1)*o},{spatialReference:M}=s.rasterInfo,O=s.getPyramidPixelSize(e),{x:Z,y:D}=O;return{extent:new F.Z({xmin:n.x+y*o*Z,xmax:n.x+(x+1)*o*Z,ymin:n.y-(v+1)*u*D,ymax:n.y-g*u*D,spatialReference:M}),pixelBlocks:k,mosaicSize:P,isPartiallyFilled:S}})()}fetchRawTile(e,t,r,n){throw new o.Z("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(e){return(0,V.tB)(this.rasterInfo.extent,e)}decodePixelBlock(e,t){return!this.rasterJobHandler||t.useCanvas?(0,U.Jx)(e,t):this.rasterJobHandler.decode({data:e,options:t})}request(e,t,r){var i=this;return(0,n.Z)(function*(){var n,s;const{customFetchParameters:a}=i.ioConfig,{range:o,query:l,headers:u}=t;r=null!=(n=null!=(s=r)?s:t.retryCount)?n:i.ioConfig.retryCount;const f=o?{Range:`bytes=${o.from}-${o.to}`}:null;try{return yield(0,I.default)(e,{...t,query:{...l,...a},headers:{...u,...f}})}catch(c){if(r>0)return r--,i.request(e,t,r);throw c}})()}getSliceIndex(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!(0,l.pC)(t)||null==e||!e.length)return null;let r=0;const n=e[0].variableName;for(let i=0;i<t.variables.length;i++){const s=t.variables[i],a=s.dimensions;if(s.name!==n){r+=a.map(e=>this._getDimensionValuesCount(e)).reduce((e,t)=>e+t);break}const o=a.map(e=>this._getDimensionValuesCount(e)),l=a.length;for(let t=0;t<l;t++){const n=e.filter(e=>e.dimensionName===a[t].name)[0];if(null==n)return null;const i=Array.isArray(n.values[0])?n.values[0][0]:n.values[0],s=this._getIndexFromDimensions(i,a[t]);if(-1===s)return null;o.shift(),r+=t===l-1?s:s*o.reduce((e,t)=>e+t)}}return r}updateTileInfo(){const{storageInfo:e,spatialReference:t,extent:r,pixelSize:n}=this.rasterInfo;if(!e.tileInfo){const i=[],s=e.maximumPyramidLevel||0;let a=Math.max(n.x,n.y),o=1/.0254*96*a;for(let e=0;e<=s;e++)i.push({level:s-e,resolution:a,scale:o}),a*=2,o*=2;const l=new $.Z({x:r.xmin,y:r.ymax,spatialReference:t});e.tileInfo=new R.Z({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:i}),e.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(e,t=512,r=512,n){const{width:i,height:s,nativeExtent:a,pixelSize:o,spatialReference:l}=e,u=new $.Z({x:a.xmin,y:a.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,s))/Math.LN2-8)));const f=this.computeBlockBoundary(a,512,512,{x:a.xmin,y:a.ymax},[o],n);e.storageInfo=new J.Z({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:f})}computeBestPyramidLevelForLocation(e,t={}){return(0,n.Z)(function*(){return 0})()}computeBlockBoundary(e,t,r,n,i,s=0,a=2){if(1===i.length&&s>0){i=[...i];let{x:e,y:t}=i[0];for(let r=0;r<s;r++)e*=a,t*=a,i.push({x:e,y:t})}const o=[],{x:l,y:u}=n;for(let f=0;f<i.length;f++){const{x:n,y:s}=i[f];o.push({minCol:Math.floor((e.xmin-l+.1*n)/t/n),maxCol:Math.floor((e.xmax-l-.1*n)/t/n),minRow:Math.floor((u-e.ymax+.1*s)/r/s),maxRow:Math.floor((u-e.ymin-.1*s)/r/s)})}return o}getPyramidPixelSize(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:r,pyramidScalingFactor:n}=this.rasterInfo.storageInfo;if(0===e)return t;if((0,l.pC)(r)&&r.length)return r[e-1];const i=n**e;return{x:t.x*i,y:t.y*i}}identifyPixelLocation(e,t,r){const{spatialReference:n,nativeExtent:i}=this.rasterInfo,{blockWidth:s,blockHeight:a,maximumPyramidLevel:o,origin:l}=this.rasterInfo.storageInfo,u=(0,V.nF)(e,n,r);if(!i.intersects(u))return null;if(t<0||t>o)return null;const f=this.getPyramidPixelSize(t),{x:c,y:d}=f,p=(l.y-u.y)/d/a,m=(u.x-l.x)/c/s,h=Math.min(a-1,Math.floor((p-Math.floor(p))*a)),y=Math.min(s-1,Math.floor((m-Math.floor(m))*s));return{pyramidLevel:t,row:Math.floor(p),col:Math.floor(m),rowOffset:h,colOffset:y,srcLocation:u}}getTileExtent(e,t,r,n,i,s){const[a,o]=s,l=n.x+r*a*e.x,u=n.y-t*o*e.y;return new F.Z({xmin:l,xmax:l+a*e.x,ymin:u-o*e.y,ymax:u,spatialReference:i})}getBlockWidthHeight(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(e,t,r){const n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}_fetchRawTile(e,t,r,n){const i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);const{minRow:s,minCol:a,maxCol:o,maxRow:u}=i;if(t<s||r<a||t>u||r>o)return Promise.resolve(null);const c=(0,j.Rq)(this.url,n.sliceId),d=`${e}/${t}/${r}`;let p=(0,j.Qg)(c,n.registryId,d);if((0,l.Wi)(p)){const i=(0,f.yi)();p=this.fetchRawTile(e,t,r,{...n,signal:i.signal}),(0,j.gX)(c,n.registryId,d,p,i),p.catch(()=>(0,j.Gc)(c,n.registryId,d))}return n.signal&&(0,f.fu)(n,()=>{(0,j.OE)(c,n.registryId,d)}),p}_getIndexFromDimensions(e,t){const{extent:r,interval:n,unit:i,values:s}=t;if(null!=s&&s.length)return Array.isArray(s[0])?s.findIndex(t=>t[0]<=e&&t[1]>=e):s.indexOf(e);if(e>r[1])return-1;const a=r[0];let o=-1;if("ISO8601"===i){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":o=Math.round((e-a)/1e3/n);break;case"minutes":o=Math.round((e-a)/6e4/n);break;case"hours":o=Math.round((e-a)/36e5/n);break;case"days":o=Math.round((e-a)/864e5/n);break;case"years":o=Math.round((new Date(e).getUTCFullYear()-new Date(a).getUTCFullYear())/n);break;case"decades":o=Math.round((new Date(e).getUTCFullYear()-new Date(a).getUTCFullYear())/10/n)}return o}return Math.round((e-a)/n)}_getDimensionValuesCount(e){const{extent:t,interval:r,unit:n,values:i}=e;let s=(null==i?void 0:i.length)||0;if(s)return s;const a=t[0];if(0===s&&"ISO8601"===n){var o;switch((null==(o=e.intervalUnit)?void 0:o.toLowerCase())||"seconds"){case"seconds":s=Math.round((t[1]-t[0])/1e3/r);break;case"minutes":s=Math.round((t[1]-t[0])/6e4/r);break;case"hours":s=Math.round((t[1]-t[0])/36e5/r);break;case"days":s=Math.round((t[1]-t[0])/864e5/r);break;case"years":s=Math.round((new Date(t[1]).getUTCFullYear()-new Date(a).getUTCFullYear())/r);break;case"decades":s=Math.round((new Date(t[1]).getUTCFullYear()-new Date(a).getUTCFullYear())/10/r)}return s}return Math.round((t[1]-t[0])/r)}_getRasterTileAlignmentInfo(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=(0,V.P_)(this.rasterInfo)),(0,l.pC)(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[e]}:null}_getRequestOptionsWithSliceId(e){var t;return null!=(t=e.multidimensionalDefinition)&&t.length&&(0,l.pC)(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e={...e,sliceId:this.getSliceIndex(e.multidimensionalDefinition)||0}),e}};(0,i._)([(0,c.Cb)()],Y.prototype,"_rasterTileAlighmentInfo",void 0),(0,i._)([(0,c.Cb)(_.HQ)],Y.prototype,"url",null),(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],Y.prototype,"datasetName",void 0),(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],Y.prototype,"datasetFormat",void 0),(0,i._)([(0,c.Cb)()],Y.prototype,"rasterInfo",void 0),(0,i._)([(0,c.Cb)()],Y.prototype,"ioConfig",void 0),(0,i._)([(0,c.Cb)()],Y.prototype,"sourceJSON",void 0),Y=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.BaseRaster")],Y);var X=Y,K=r(19245);function Q(e){const t=e.fields,r=e.records,n=t.some(e=>"oid"===e.name.toLowerCase())?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map(e=>({name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}))),s=i.map(e=>e.name),a=[];let o=0,l=0;return r.forEach(e=>{const t={};for(t[n]=o++,l=1;l<s.length;l++)t[s[l]]=e[l-1];a.push({attributes:t})}),{displayFieldName:"",fields:i,features:a}}class ee{static get supportedVersions(){return[5]}static parse(e){const t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};const n=t.getUint32(4,!0),i=t.getUint16(8,!0),s=t.getUint16(10,!0),a={version:r,recordCount:n,headerByteCount:i,recordByteCount:s};let o=32;const l=[],u=[];let f;if(3===r){for(;13!==t.getUint8(o);)f=String.fromCharCode(t.getUint8(o+11)).trim(),l.push({name:(0,K.f)(new Uint8Array(e,o,11)),type:f,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(f)],length:t.getUint8(o+16)}),o+=32;if(o+=1,l.length>0)for(;u.length<n&&e.byteLength-o>s;){const r=[];32===t.getUint8(o)?(o+=1,l.forEach(t=>{if("C"===t.type)r.push((0,K.f)(new Uint8Array(e,o,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,o,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,o,t.length)).trim()));else if("D"===t.type){const n=String.fromCharCode.apply(null,new Uint8Array(e,o,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}o+=t.length}),u.push(r)):o+=s}}return{header:a,fields:l,records:u,recordSet:Q({fields:l,records:u})}}}let te=class extends W.wq{constructor(){super(...arguments),this.affectsPixelSize=!1}forwardTransform(e){return e}inverseTransform(e){return e}};(0,i._)([(0,c.Cb)()],te.prototype,"affectsPixelSize",void 0),(0,i._)([(0,c.Cb)({json:{write:!0}})],te.prototype,"spatialReference",void 0),te=(0,i._)([(0,y.j)("esri.layers.support.rasterTransforms.BaseRasterTransform")],te);var re=te;let ne=class extends re{constructor(){super(...arguments),this.type="identity"}};(0,i._)([(0,m.J)({IdentityXform:"identity"})],ne.prototype,"type",void 0),ne=(0,i._)([(0,y.j)("esri.layers.support.rasterTransforms.IdentityTransform")],ne);var ie=ne,se=r(66081);function ae(e,t,r){const{x:n,y:i}=t;if(r<2)return{x:e[0]+n*e[2]+i*e[4],y:e[1]+n*e[3]+i*e[5]};if(2===r){const t=n*n,r=i*i,s=n*i;return{x:e[0]+n*e[2]+i*e[4]+t*e[6]+s*e[8]+r*e[10],y:e[1]+n*e[3]+i*e[5]+t*e[7]+s*e[9]+r*e[11]}}const s=n*n,a=i*i,o=n*i,l=s*n,u=s*i,f=n*a,c=i*a;return{x:e[0]+n*e[2]+i*e[4]+s*e[6]+o*e[8]+a*e[10]+l*e[12]+u*e[14]+f*e[16]+c*e[18],y:e[1]+n*e[3]+i*e[5]+s*e[7]+o*e[9]+a*e[11]+l*e[13]+u*e[15]+f*e[17]+c*e[19]}}function oe(e,t,r){const{xmin:n,ymin:i,xmax:s,ymax:a,spatialReference:o}=t;let l=[];if(r<2)l.push({x:n,y:a}),l.push({x:s,y:a}),l.push({x:n,y:i}),l.push({x:s,y:i});else{let e=10;for(let t=0;t<e;t++)l.push({x:n,y:i+(a-i)*t/(e-1)}),l.push({x:s,y:i+(a-i)*t/(e-1)});e=8;for(let t=1;t<=e;t++)l.push({x:n+(s-n)*t/e,y:i}),l.push({x:n+(s-n)*t/e,y:a})}l=l.map(t=>ae(e,t,r));const u=l.map(e=>e.x),f=l.map(e=>e.y);return new F.Z({xmin:Math.min.apply(null,u),xmax:Math.max.apply(null,u),ymin:Math.min.apply(null,f),ymax:Math.max.apply(null,f),spatialReference:o})}let le=class extends re{constructor(){super(...arguments),this.polynomialOrder=1,this.type="polynomial"}readForwardCoefficients(e,t){const{coeffX:r,coeffY:n}=t;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;const i=[];for(let s=0;s<r.length;s++)i.push(r[s]),i.push(n[s]);return i}writeForwardCoefficients(e,t,r){const n=[],i=[];for(let s=0;s<(null==e?void 0:e.length);s++)s%2==0?n.push(e[s]):i.push(e[s]);t.coeffX=n,t.coeffY=i}get inverseCoefficients(){let e=this._get("inverseCoefficients");const t=this._get("forwardCoefficients");return!e&&t&&this.polynomialOrder<2&&(e=function(e){const[t,r,n,i,s,a]=e,o=n*a-s*i,l=s*i-n*a;return[(s*r-t*a)/o,(n*r-t*i)/l,a/o,i/l,-s/o,-n/l]}(t)),e}set inverseCoefficients(e){this._set("inverseCoefficients",e)}readInverseCoefficients(e,t){const{inverseCoeffX:r,inverseCoeffY:n}=t;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;const i=[];for(let s=0;s<r.length;s++)i.push(r[s]),i.push(n[s]);return i}writeInverseCoefficients(e,t,r){const n=[],i=[];for(let s=0;s<(null==e?void 0:e.length);s++)s%2==0?n.push(e[s]):i.push(e[s]);t.inverseCoeffX=n,t.inverseCoeffY=i}forwardTransform(e){if("point"===e.type){const t=ae(this.forwardCoefficients,e,this.polynomialOrder);return new $.Z({x:t.x,y:t.y,spatialReference:e.spatialReference})}return oe(this.forwardCoefficients,e,this.polynomialOrder)}inverseTransform(e){if("point"===e.type){const t=ae(this.inverseCoefficients,e,this.polynomialOrder);return new $.Z({x:t.x,y:t.y,spatialReference:e.spatialReference})}return oe(this.inverseCoefficients,e,this.polynomialOrder)}};(0,i._)([(0,c.Cb)({json:{write:!0}})],le.prototype,"polynomialOrder",void 0),(0,i._)([(0,c.Cb)()],le.prototype,"forwardCoefficients",void 0),(0,i._)([(0,h.r)("forwardCoefficients",["coeffX","coeffY"])],le.prototype,"readForwardCoefficients",null),(0,i._)([(0,se.c)("forwardCoefficients")],le.prototype,"writeForwardCoefficients",null),(0,i._)([(0,c.Cb)({json:{write:!0}})],le.prototype,"inverseCoefficients",null),(0,i._)([(0,h.r)("inverseCoefficients",["inverseCoeffX","inverseCoeffY"])],le.prototype,"readInverseCoefficients",null),(0,i._)([(0,se.c)("inverseCoefficients")],le.prototype,"writeInverseCoefficients",null),(0,i._)([(0,c.Cb)()],le.prototype,"affectsPixelSize",void 0),(0,i._)([(0,m.J)({PolynomialXform:"polynomial"})],le.prototype,"type",void 0),le=(0,i._)([(0,y.j)("esri.layers.support.rasterTransforms.PolynomialTransform")],le);var ue=le;const fe={PolynomialXform:ue,IdentityXform:ie},ce=Object.keys(fe);function de(e){return!e||ce.includes(null==e?void 0:e.type)}var pe=r(41586);const me=new Map;me.set("int16","esriFieldTypeSmallInteger"),me.set("int32","esriFieldTypeInteger"),me.set("int64","esriFieldTypeInteger"),me.set("float32","esriFieldTypeSingle"),me.set("float64","esriFieldTypeDouble"),me.set("text","esriFieldTypeString");let he=class extends X{constructor(){super(...arguments),this.storageInfo=null,this.datasetFormat="CRF"}open(e){var t=this;return(0,n.Z)(function*(){yield t.init();const{data:r}=yield t.request(t.url+"/conf.json",{signal:null==e?void 0:e.signal});if(!t._validateHeader(r))throw new o.Z("cloudraster:open","Invalid or unsupported conf.json.");t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const{storageInfo:n,rasterInfo:i}=t._parseHeader(r);if("thematic"===i.dataType){const e=yield t._fetchAuxiliaryInformation();i.attributeTable=e}t._set("storageInfo",n),t._set("rasterInfo",i),t.ioConfig.retryCount=t.ioConfig.retryCount||0})()}fetchRawTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){const n=s.rasterInfo.storageInfo.maximumPyramidLevel-e;if(n<0)return null;const a=s._buildCacheFilePath(n,t,r,i.multidimensionalDefinition),o=s._getIndexRecordFromBundle(t,r),l=yield s.request(a,{range:{from:0,to:s.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});if(!l)return null;const u=new Uint8Array(l.data),f=s._getTileEndAndContentType(u,o);if(0===f.recordSize)return null;const c=yield s.request(a,{range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer",signal:i.signal});return c?s.decodePixelBlock(c.data,{width:s.rasterInfo.storageInfo.tileInfo.size[0],height:s.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null}):null})()}_validateHeader(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some(t=>!e[t])}_parseHeader(e){var t,r;const n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],{bandCount:i,histograms:s,colormap:a,blockWidth:o,blockHeight:l,firstPyramidLevel:u,maximumPyramidLevel:f}=e,c=e.statistics&&e.statistics.map(e=>({min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode})),d=e.extent.spatialReference,p=null==(t=e.geodataXform)?void 0:t.spatialReference,m=new O.Z(null!=d&&d.wkid||null!=d&&d.wkt?d:p);let h=new F.Z({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:m});const y=new $.Z({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:m}),g=Math.round((h.xmax-h.xmin)/y.x),x=Math.round((h.ymax-h.ymin)/y.y),v=this._parseTransform(e.geodataXform),I=v?h:null;v&&(h=v.forwardTransform(h),y.x=(h.xmax-h.xmin)/g,y.y=(h.ymax-h.ymin)/x);const b=null!=(r=e.properties)?r:{},w=e.format.toLowerCase().replace("cache/",""),C=new $.Z(e.origin.x,e.origin.y,m);let _,T,S,k;if(a&&a.colors)for(_=[],T=0;T<a.colors.length;T++)S=a.colors[T],k=a.values?a.values[T]:T,_.push([k,255&S,S<<16>>>24,S<<8>>>24,S>>>24]);const P=e.LODInfos,M=[];for(T=0;T<P.levels.length;T++)M.push({level:P.levels[T],resolution:P.resolutions[T],scale:96/.0254*P.resolutions[T]});const Z=new R.Z({dpi:96,lods:M,format:w,origin:C,size:[o,l],spatialReference:m}),D={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},B=[{maxCol:Math.ceil(g/o)-1,maxRow:Math.ceil(x/l)-1,minCol:0,minRow:0}];let z=2;if(f>0)for(T=0;T<f;T++)B.push({maxCol:Math.ceil(g/z/o)-1,maxRow:Math.ceil(x/z/l)-1,minCol:0,minRow:0}),z*=2;return{storageInfo:D,rasterInfo:new L.Z({width:g,height:x,pixelType:n,bandCount:i,extent:h,nativeExtent:I,transform:v,spatialReference:m,pixelSize:y,keyProperties:b,statistics:c,histograms:s,multidimensionalInfo:e.mdInfo,colormap:_,storageInfo:new J.Z({blockWidth:o,blockHeight:l,pyramidBlockWidth:o,pyramidBlockHeight:l,origin:C,tileInfo:Z,firstPyramidLevel:u,maximumPyramidLevel:f,blockBoundary:B})})}}_parseTransform(e){var t,r;if(!de(e))throw new o.Z("cloudraster:open","the data contains unsupported geodata transform types");const n=function(e){if(!(null==e?void 0:e.type))return null;const t=fe[null==e?void 0:e.type];if(t){const r=new t;return r.read(e),r}return null}(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null==(t=n.forwardCoefficients)||!t.length||null==(r=n.inverseCoefficients)||!r.length)throw new o.Z("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}_fetchAuxiliaryInformation(e){var t=this;return(0,n.Z)(function*(){const r=t.request(t.url+"/conf.vat.json",{signal:e}).then(e=>e.data).catch(()=>null),n=t.request(t.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then(e=>e.data).catch(()=>null),i=yield Promise.all([r,n]);let s;if(i[0]){let e=i[0].fields;const t=i[0].values;if(e&&t){e=e.map(e=>({type:"OID"===e.name?"esriFieldTypeOID":me.get(e.type),name:e.name,alias:e.alias||e.name}));const r=t.map(e=>({attributes:e}));e&&t&&(s={fields:e,features:r})}}return!s&&i[1]&&(s=ee.parse(i[1]).recordSet),pe.default.fromJSON(s)})()}_buildCacheFilePath(e,t,r,n){const i=this.storageInfo.packetSize,s=Math.floor(t/i)*i,a=Math.floor(r/i)*i,o="R"+this._toHexString4(s)+"C"+this._toHexString4(a);let u="L";u+=e>=10?e.toString():"0"+e.toString();const{multidimensionalInfo:f}=this.rasterInfo,c=null==n?void 0:n[0];if(!(0,l.pC)(f)||!c)return`${this.url}/_alllayers/${u}/${o}.bundle`;let d=f.variables.filter(e=>e.name===c.variableName)[0].dimensions[0].values.indexOf(c.values[0]).toString(16);const p=4-d.length;for(let l=0;l<p;l++)d="0"+d;return d="S"+d,`${this.url}/_alllayers/${c.variableName}/${d}/${u}/${o}.bundle`}_getIndexRecordFromBundle(e,t){const r=this.storageInfo.packetSize,n=r*(e%r)+t%r;if(n<0)throw"Invalid level / row / col";return 20+n*this.storageInfo.recordSize+44}_getTileEndAndContentType(e,t){const r=e.subarray(t,t+8);let n,i=0;for(n=0;n<5;n++)i|=(255&r[n])<<8*n;const s=0xffffffffff&i;for(i=0,n=5;n<8;n++)i|=(255&r[n])<<8*(n-5);return{position:s,recordSize:0xffffffffff&i}}_toHexString4(e){let t=e.toString(16);if(4!==t.length){let e=4-t.length;for(;e-- >0;)t="0"+t}return t}};(0,i._)([(0,c.Cb)({readOnly:!0})],he.prototype,"storageInfo",void 0),(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],he.prototype,"datasetFormat",void 0),he=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.CloudRaster")],he);var ye=he;let ge=class extends X{constructor(){super(...arguments),this.datasetFormat="MEMORY"}open(e){var t=this;return(0,n.Z)(function*(){var r;yield t.init();const{pixelBlock:n,statistics:i,histograms:s,name:a,keyProperties:o,nativeExtent:l,transform:u}=t.data,{width:f,height:c,pixelType:d}=n,p=t.data.extent||new F.Z({xmin:-.5,ymin:.5,xmax:f-.5,ymax:c-.5,spatialReference:new O.Z({wkid:3857})}),m=null!=(r=t.data.isPseudoSpatialReference)?r:!t.data.extent,h=new L.Z({width:f,height:c,pixelType:d,extent:p,nativeExtent:l,transform:u,pixelSize:{x:p.width/f,y:p.height/c},spatialReference:p.spatialReference,bandCount:3,keyProperties:o||{},statistics:i,isPseudoSpatialReference:m,histograms:s});t.createRemoteDatasetStorageInfo(h,512,512),t._set("rasterInfo",h),t.updateTileInfo(),yield t._buildInMemoryRaster(n,{width:512,height:512},e),t.datasetName=a,t.url="/InMemory/"+a})()}fetchRawTile(e,t,r,n={}){const i=this._pixelBlockTiles.get(`${e}/${t}/${r}`);return Promise.resolve(i)}_buildInMemoryRaster(e,t,r){var i=this;return(0,n.Z)(function*(){const n=i.rasterInfo.storageInfo.maximumPyramidLevel,s=i.rasterJobHandler?i.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:n},r):Promise.resolve((0,G.Vl)(e,t,n)),a=(0,l.pC)(i.rasterInfo.statistics),u=(0,l.pC)(i.rasterInfo.histograms),c=a&&u?Promise.resolve({statistics:null,histograms:null}):i.rasterJobHandler?i.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},r):Promise.resolve((0,G.Hv)(e)),d=yield(0,f.as)([s,c]);if(!d[0].value&&d[1].value)throw new o.Z("inmemory-raster:open","failed to build in memory raster");var p,m;i._pixelBlockTiles=d[0].value,a||(i.rasterInfo.statistics=null==(p=d[1].value)?void 0:p.statistics),u&&(i.rasterInfo.histograms=null==(m=d[1].value)?void 0:m.histograms)})()}};(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],ge.prototype,"datasetFormat",void 0),(0,i._)([(0,c.Cb)()],ge.prototype,"data",void 0),ge=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.InMemoryRaster")],ge);var xe=ge;function ve(e,t){if(!e||!t)return[];let r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const n=[];if(t){const i=ve(e,r);for(let e=0;e<i.length;e++)ve(i[e],t).forEach(e=>n.push(e));return n}const i=e.getElementsByTagNameNS("*",r);if(!i||0===i.length)return[];for(let s=0;s<i.length;s++)n.push(i[s]||i.item[s]);return n}function Ie(e,t){if(!e||!t)return null;let r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const n=ve(e,r);return n.length>0?t?Ie(n[0],t):n[0]:null}function be(e,t=null){const r=t?Ie(e,t):e;let n;return r?(n=r.textContent||r.nodeValue,n?n.trim():null):null}function we(e,t){const r=ve(e,t),n=[];let i;for(let s=0;s<r.length;s++)i=r[s].textContent||r[s].nodeValue,i&&(i=i.trim(),""!==i&&n.push(i));return n}function Ce(e,t){return we(e,t).map(e=>Number(e))}function _e(e,t){const r=be(e,t);return Number(r)}function Te(e,t){var r;const n=null==e||null==(r=e.nodeName)?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}function Se(e,t){if(!e||!t)return null;const r=[];for(let n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function Re(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new O.Z({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const r=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),i=n>-1?n:e.indexOf("GEOGCS");if(-1===i)return null;const s=e.slice(i,e.lastIndexOf("]",r)+1).trim(),a=e.slice(i,e.lastIndexOf("]")).trim();t=ke(s);const o=new O.Z(t?{wkid:t}:{wkt:s}),l=ke(a);return l&&(o.vcsWkid=l),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=ke(e),new O.Z(0!==t?{wkid:t}:{wkt:e})):null}function ke(e){const t=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map(e=>e.trim()).filter(e=>""!==e),r=t[t.length-1].split(",");if("EPSG"===r[0]&&e.endsWith('"]]')){const e=Number(r[1]);if(!isNaN(e)&&0!==e)return e}return 0}function Pe(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};const r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(1===e.nodeType)if(Te(e,"SRS")){if(!r.spatialReference){const t=be(e);r.spatialReference=Re(t)}}else if(Te(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=function(e){var t;const r=Ie(e,"GeodataXform"),n=Re(_e(r,"SpatialReference/WKID")||be(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const i=null!=(t=_e(r,"PolynomialOrder"))?t:1,s=Ce(r,"CoeffX/Double"),a=Ce(r,"CoeffY/Double"),o=Ce(r,"InverseCoeffX/Double"),l=Ce(r,"InverseCoeffY/Double"),u=Se(s,a),f=Se(o,l);return{spatialReference:n,transform:new ue({spatialReference:n,polynomialOrder:i,forwardCoefficients:u,inverseCoefficients:f})}}(e);r.transform=n,r.spatialReference||(r.spatialReference=t)}else ve(e,"MDI").forEach(e=>r.metadata[e.getAttribute("key")]=be(e));else if(Te(e,"PAMRasterBand")){const t=function(e){var t;const r=_e(e,"NoDataValue"),n=Ie(e,"Histograms/HistItem"),i=_e(n,"HistMin"),s=_e(n,"HistMax"),a=_e(n,"BucketCount"),o=null==(t=be(n,"HistCounts"))?void 0:t.split("|").map(e=>Number(e));let l,u,f,c;ve(e,"Metadata/MDI").forEach(e=>{var t;const r=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":l=r;break;case"STATISTICS_MAXIMUM":u=r;break;case"STATISTICS_MEAN":f=r;break;case"STATISTICS_STDDEV":c=r}});const d=_e(e,"Metadata/SourceBandIndex");return{noDataValue:r,histogram:null!=o&&o.length&&null!=l&&null!=u?{min:i,max:s,size:a||o.length,counts:o}:null,sourceBandIndex:d,statistics:null!=l&&null!=u?{min:l,max:u,avg:f,stddev:c}:null}}(e);null!=t.sourceBandIndex&&null==r.rasterBands[t.sourceBandIndex]?r.rasterBands[t.sourceBandIndex]=t:r.rasterBands.push(t)}});const n=r.rasterBands;return n&&(r.statistics=n[0].statistics?n.map(e=>e.statistics):null,r.histograms=n[0].histogram?n.map(e=>e.histogram):null),r}let Me=class extends X{open(e){var t=this;return(0,n.Z)(function*(){yield t.init();const r=yield t._fetchData(e);let{spatialReference:n,statistics:i,histograms:s,transform:a}=yield t._fetchAuxiliaryData(e);const o=!n;o&&(n=new O.Z({wkid:3857})),null!=s&&s.length&&null==i&&(i=(0,G.Oh)(s));const{width:l,height:u}=r;let f=new F.Z({xmin:-.5,ymin:.5-u,xmax:l-.5,ymax:.5,spatialReference:n});const c=a?a.forwardTransform(f):f;let d=!0;if(a){const e=a.forwardCoefficients;d=e&&0===e[1]&&0===e[2],d&&(a=null,f=c)}const p=new xe({data:{extent:c,nativeExtent:f,transform:a,pixelBlock:r,statistics:i,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:o}});yield p.open(),t._set("rasterInfo",p.rasterInfo),t._inMemoryRaster=p})()}fetchRawTile(e,t,r,n={}){return this._inMemoryRaster.fetchRawTile(e,t,r,n)}_fetchData(e){var t=this;return(0,n.Z)(function*(){const{data:r}=yield t.request(t.url,{responseType:"array-buffer",signal:null==e?void 0:e.signal}),n=(0,U.y6)(r).toUpperCase();if("JPG"!==n&&"PNG"!==n&&"GIF"!==n&&"BMP"!==n)throw new o.Z("image-aux-raster:open","the data is not a supported format");return t._set("datasetFormat",n),yield t.decodePixelBlock(r,{format:"jpg",width:1,height:1,useCanvas:!0})})()}_fetchAuxiliaryData(e){var t=this;return(0,n.Z)(function*(){var r,n;const i=(0,l.Wg)(null==e?void 0:e.signal),s=null!=(r=t.ioConfig.skipExtensions)?r:[],a=s.indexOf("aux.xml")>-1?null:t.request(t.url+".aux.xml",{responseType:"xml",signal:i}),o=t.datasetFormat,u="JPG"===o?"jgw":"PNG"===o?"pgw":"BMP"===o?"bpw":null,c=s.indexOf(u)>-1?null:t.request(t.url.slice(0,t.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:i}),d=yield(0,f.as)([a,c]);if(null!=i&&i.aborted)throw(0,f.zE)();const p=Pe(null==(n=d[0].value)?void 0:n.data);if(!p.transform){const e=d[1].value?d[1].value.data.split("\n").slice(0,6).map(e=>Number(e)):null;p.transform=6===(null==e?void 0:e.length)?new ue({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return p})()}};(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],Me.prototype,"datasetFormat",void 0),Me=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Me);var Fe=Me,Oe=r(57319),Ze=r(85365),De=r(10478);let Be=class extends re{constructor(){super(...arguments),this.type="gcs-shift",this.tolerance=1e-8}forwardTransform(e){return"point"===(e=e.clone()).type?(e.x>180+this.tolerance&&(e.x-=360),e):(e.xmin>=180-this.tolerance?(e.xmax-=360,e.xmin-=360):e.xmax>180+this.tolerance&&(e.xmin=-180,e.xmax=180),e)}inverseTransform(e){return"point"===(e=e.clone()).type?(e.x<-this.tolerance&&(e.x+=360),e):(e.xmin<-this.tolerance&&(e.xmin+=360,e.xmax+=360),e)}};(0,i._)([(0,m.J)({GCSShiftXform:"gcs-shift"})],Be.prototype,"type",void 0),(0,i._)([(0,c.Cb)()],Be.prototype,"tolerance",void 0),Be=(0,i._)([(0,y.j)("esri.layers.support.rasterTransforms.GCSShiftTransform")],Be);var ze=Be;let Ee=class extends X{constructor(){super(...arguments),this._levelOffset=0,this._slices=null,this._tilemapCache=null,this.datasetFormat="RasterTileServer"}open(e){var t=this;return(0,n.Z)(function*(){yield t.init();const r=e&&e.signal,n=t.sourceJSON?{data:t.sourceJSON}:yield t.request(t.url,{query:{f:"json"},signal:r});n.ssl&&(t.url=t.url.replace(/^http:/i,"https:"));const i=n.data;if(t.sourceJSON=i,!i)throw new o.Z("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!i.tileInfo)throw new o.Z("imageserverraster:open","use ImageryLayer to open non-tiled image services");t._fixScaleInServiceInfo(),t.tileType=i.cacheType,null==t.tileType&&(t.tileType=["jpg","jpeg","png","png8","png24","png32","mixed"].indexOf(i.tileInfo.format.toLowerCase())>-1?"Map":"lerc"===i.tileInfo.format.toLowerCase()?"Elevation":"Raster"),t.datasetName=i.name.slice(i.name.indexOf("/")+1);const s=yield t._fetchRasterInfo({signal:r});if(!(0,l.pC)(s))throw new o.Z("image-server-raster:open","cannot initialize image service");{const e="Map"===t.tileType?(0,Ze.d)(i.tileInfo,i):R.Z.fromJSON(i.tileInfo),{extent:r,pixelSize:n}=s,a=.5/s.width*n.x;let o,l;const u=e.lodAt(Math.max.apply(null,e.lods.map(e=>e.level)));"Map"!==t.tileType&&0!==i.maxScale&&("Raster"===t.tileType?(o=e.lods.filter(e=>e.resolution===n.x)[0],o||(o=e.lods[e.lods.length-1])):(o=e.lods.filter(e=>Math.abs(e.scale-i.maxScale)<a)[0],o||(o=e.lods.filter(e=>e.scale>i.maxScale).sort((e,t)=>e.scale>t.scale?1:-1)[0])),n.x=n.y=o.resolution,s.width=Math.ceil((r.xmax-r.xmin)/n.x-.1),s.height=Math.ceil((r.ymax-r.ymin)/n.y-.1)),o||(o=u);const f=e.lodAt(Math.min.apply(null,e.lods.map(e=>e.level)));"Map"===t.tileType?t._levelOffset=e.lods[0].level:0!==i.minScale&&"Elevation"===t.tileType&&(l=e.lods.filter(e=>Math.abs(e.scale-i.minScale)<a)[0],t._levelOffset=l.level-f.level),l||(l=f);const c=Math.max(n.x,n.y);(Math.abs(n.x-n.y)>a||!e.lods.some(e=>Math.abs(e.resolution-c)<a))&&(n.x=n.y=o.resolution,s.width=Math.ceil((r.xmax-r.xmin)/n.x-.1),s.height=Math.ceil((r.ymax-r.ymin)/n.y-.1));const d=o.level-l.level,[p,m]=e.size,h=[];e.lods.forEach(e=>{e.level>=l.level&&e.level<=o.level&&h.push({x:e.resolution,y:e.resolution})}),h.sort((e,t)=>e.x-t.x);const y=t.computeBlockBoundary(r,p,m,e.origin,h,d),g=h.length>1?h.slice(1):null;s.storageInfo=new J.Z({blockWidth:e.size[0],blockHeight:e.size[1],pyramidBlockWidth:e.size[0],pyramidBlockHeight:e.size[1],pyramidResolutions:g,compression:e.format,origin:e.origin,firstPyramidLevel:1,maximumPyramidLevel:d,tileInfo:e,blockBoundary:y}),t._fixGCSShift(s),t._set("rasterInfo",s)}if(i.capabilities.toLowerCase().indexOf("tilemap")>-1){const e={tileInfo:s.storageInfo.tileInfo,parsedUrl:(0,Oe.mN)(t.url),url:t.url,tileServers:[],type:"tile"};t._tilemapCache=new De.y({layer:e})}})()}fetchRawTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){const{storageInfo:n,extent:a}=s.rasterInfo,o=`${s.url}/tile/${n.maximumPyramidLevel-e+s._levelOffset}/${t}/${r}`,l=s._slices?{sliceId:i.sliceId||0}:null,{data:u}=yield s.request(o,{query:l,responseType:"array-buffer",signal:i.signal});if(!u)return null;const f=yield s.decodePixelBlock(u,{width:n.tileInfo.size[0],height:n.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===s.tileType}),c=n.blockBoundary[e];if("jpg"!==n.compression||r>c.minCol&&r<c.maxCol&&t>c.minRow&&t<c.maxRow)return f;const{origin:d,blockWidth:p,blockHeight:m}=n,{x:h,y:y}=s.getPyramidPixelSize(e),g=Math.round((a.xmin-d.x)/h)%p,x=Math.round((a.xmax-d.x)/h)%p,v=Math.round((d.y-a.ymax)/y)%m,I=Math.round((d.y-a.ymin)/y)%m,b=r===c.minCol?g:0,w=t===c.minRow?v:0;return(0,G.pW)(f,{x:b,y:w},{width:(r===c.maxCol?x:p)-b,height:(t===c.maxRow?I:m)-w}),f})()}getSliceIndex(e){if(null==e||!e.length||!this._slices)return null;const t=e;for(let r=0;r<this._slices.length;r++){const e=this._slices[r].multidimensionalDefinition;if(e.length===t.length&&!e.some(e=>{const r=t.filter(t=>e.variableName===t.variableName&&t.dimensionName===e.dimensionName)[0];return!r||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(r.values[0])?r.values[0][0]:r.values[0])}))return r}return null}fetchVariableStatisticsHistograms(e,t){var r=this;return(0,n.Z)(function*(){const n=r.request(r.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then(e=>{var t;return null==(t=e.data)?void 0:t.statistics}),i=r.request(r.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then(e=>{var t;return null==(t=e.data)?void 0:t.histograms}),s=yield Promise.all([n,i]);return s[0]&&s[0].forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),{statistics:s[0]||null,histograms:s[1]||null}})()}computeBestPyramidLevelForLocation(e,t={}){var r=this;return(0,n.Z)(function*(){if(!r._tilemapCache)return 0;let n=r.identifyPixelLocation(e,0,(0,l.Wg)(t.datumTransformation));if(null===n)return null;let i=0;const{maximumPyramidLevel:s}=r.rasterInfo.storageInfo;let a=s-i+r._levelOffset;const o=n.srcLocation;for(;a>=0;){try{if("available"===(yield r._tilemapCache.fetchAvailability(a,n.row,n.col,t)))break}catch{}if(a--,i++,n=r.identifyPixelLocation(o,i,(0,l.Wg)(t.datumTransformation)),null===n)return null}return-1===a||null==n?null:i})()}_fetchRasterInfo(e){var t=this;return(0,n.Z)(function*(){const r=t.sourceJSON,n=Math.ceil((r.extent.xmax-r.extent.xmin)/r.pixelSizeX-.1),i=Math.ceil((r.extent.ymax-r.extent.ymin)/r.pixelSizeY-.1),s=O.Z.fromJSON(r.spatialReference||r.extent.spatialReference);if("Map"===t.tileType)return new L.Z({width:n,height:i,bandCount:3,extent:F.Z.fromJSON(r.extent),spatialReference:s,pixelSize:new $.Z({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:s}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}});const{slice:a,signal:o}=e,l=!!r.hasRasterAttributeTable&&t.request(t.url+"/rasterAttributeTable",{query:{slice:a,f:"json"},signal:o}).then(e=>pe.default.fromJSON(e.data)).catch(()=>null),u=!!r.hasColormap&&t.request(t.url+"/colormap",{query:{slice:a,f:"json"},signal:o}).then(e=>{var t;return null==(t=e.data)?void 0:t.colormap}),f=!!r.hasHistograms&&t.request(t.url+"/histograms",{query:{slice:a,f:"json"},signal:o}).then(e=>{var t;return null==(t=e.data)?void 0:t.histograms}),c=t.request(t.url+"/keyProperties",{query:{f:"json"},signal:o}).then(e=>e.data).catch(()=>{}),d=!!r.hasMultidimensions&&t._fetchMultidimensionalInfo(),p=!!r.hasMultidimensions&&t.request(t.url+"/slices",{query:{f:"json"},signal:o}).then(e=>e.data&&e.data.slices).catch(()=>{});return Promise.all([l,u,f,c,d,p]).then(e=>{let a=null;if(r.minValues&&r.minValues.length===r.bandCount){a=[];for(let e=0;e<r.minValues.length;e++)a.push({min:r.minValues[e],max:r.maxValues[e],avg:r.meanValues[e],stddev:r.stdvValues[e]})}return t._slices=e[5]||null,new L.Z({width:n,height:i,bandCount:r.bandCount,extent:F.Z.fromJSON(r.extent),spatialReference:s,pixelSize:new $.Z({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:s}),pixelType:r.pixelType.toLowerCase(),statistics:a,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})})})()}_fetchMultidimensionalInfo(e){var t=this;return(0,n.Z)(function*(){var r;const n=yield t.request(t.url+"/multidimensionalInfo",{query:{f:"json"},signal:e}).then(e=>{var t;return null==(t=e.data)?void 0:t.multidimensionalInfo});return null!=(r=n.variables)&&r.length&&n.variables.forEach(e=>{var t;null!=(t=e.statistics)&&t.length&&e.statistics.forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation})}),n})()}_fixScaleInServiceInfo(){const{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_fixGCSShift(e){const{extent:t,spatialReference:r}=e;0===t.xmin&&360===t.xmax&&r.wkid&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new ze,e.extent=e.transform.forwardTransform(t))}};(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],Ee.prototype,"datasetFormat",void 0),(0,i._)([(0,c.Cb)()],Ee.prototype,"tileType",void 0),Ee=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.ImageServerRaster")],Ee);var Ne=Ee,He=r(22332),Ae=r(95190);const Le=new Map;Le.set("Int8","s8"),Le.set("UInt8","u8"),Le.set("Int16","s16"),Le.set("UInt16","u16"),Le.set("Int32","s32"),Le.set("UInt32","u32"),Le.set("Float32","f32"),Le.set("Float64","f32"),Le.set("Double64","f32");const Je=new Map;Je.set("lerc",".lrc"),Je.set("none",".til"),Je.set("deflate",".pzp"),Je.set("jpeg",".jzp");let We=class extends X{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}open(e){var t=this;return(0,n.Z)(function*(){var r;yield t.init(),t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const n=e?(0,l.Wg)(e.signal):null,i=yield t.request(t.url,{responseType:"xml",signal:n}),{rasterInfo:s,files:a}=t._parseHeader(i.data);if(-1===(null==(r=t.ioConfig.skipExtensions)?void 0:r.indexOf("aux.xml"))){const r=yield t._fetchAuxiliaryData(e);var o;null!=r&&(s.statistics=null!=(o=r.statistics)?o:s.statistics,s.histograms=r.histograms,r.histograms&&!(0,l.pC)(s.statistics)&&(s.statistics=(0,G.Oh)(r.histograms)))}t._set("rasterInfo",s),t._files=a;const u=yield t.request(a.index,{responseType:"array-buffer",signal:n});t._storageIndex=t._parseIndex(u.data);let f,c,d=0,p=-1;const{blockWidth:m,blockHeight:h,compression:y}=t.rasterInfo.storageInfo,g=t.rasterInfo.storageInfo.pyramidScalingFactor,{width:x,height:v,bandCount:I}=t.rasterInfo,b=[],w="none"===y?1:I;for(;d<t._storageIndex.length;)p++,f=Math.ceil(x/m/g**p),c=Math.ceil(v/h/g**p),d+=f*c*w*4,b.push({maxRow:c,maxCol:f,minCol:0,minRow:0});t.rasterInfo.storageInfo.blockBoundary=b,p>0&&(t.rasterInfo.storageInfo.firstPyramidLevel=1,t.rasterInfo.storageInfo.maximumPyramidLevel=p),t.updateTileInfo()})()}fetchRawTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){const{blockWidth:n,blockHeight:a,blockBoundary:o,compression:l}=s.rasterInfo.storageInfo,u=o[e];if(!u||u.maxRow<t||u.maxCol<r||u.minRow>t||u.minCol>r)return null;const{bandCount:f,pixelType:c}=s.rasterInfo,{ranges:d,actualTileWidth:p,actualTileHeight:m}=s._getTileLocation(e,t,r);if(!d||0===d.length)return null;if(0===d[0].from&&0===d[0].to){const e=new Uint8Array(n*a);return new He.Z({width:n,height:a,pixels:null,mask:e,validPixelCount:0})}const{bandIds:h}=s.ioConfig,y="none"===l?1:f,g=[];let x=0;for(x=0;x<y;x++)(!h||h.indexOf[x]>-1)&&g.push(s.request(s._files.data,{range:{from:d[x].from,to:d[x].to},responseType:"array-buffer",signal:i.signal}));const v=yield Promise.all(g),I=v.map(e=>e.data.byteLength).reduce((e,t)=>e+t),b=new Uint8Array(I);let w=0;for(x=0;x<y;x++)b.set(new Uint8Array(v[x].data),w),w+=v[x].data.byteLength;const C="lerc"===s.rasterInfo.storageInfo.compression?"lerc":"bip",_=yield s.decodePixelBlock(b.buffer,{width:n,height:a,format:C,pixelType:c});let T=0,S=0;if(p!==n||m!==a){let e=_.mask;if(e)for(x=0;x<a;x++)if(S=x*n,x<m)for(T=p;T<n;T++)e[S+T]=0;else for(T=0;T<n;T++)e[S+T]=0;else for(e=new Uint8Array(n*a),_.mask=e,x=0;x<m;x++)for(S=x*n,T=0;T<p;T++)e[S+T]=1}return _})()}_parseIndex(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";let t,r,n,i,s,a;if(Ae.f){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),s=0;s<e.byteLength/4;s++)for(a=0;a<4;a++)n[4*s+a]=r[4*s+3-a];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}_getTileLocation(e,t,r){const{blockWidth:n,blockHeight:i,pyramidScalingFactor:s,compression:a}=this.rasterInfo.storageInfo,{width:o,height:l,bandCount:u}=this.rasterInfo,f="none"===a?1:u;let c,d,p,m=0,h=0;for(p=0;p<e;p++)h=s**p,c=Math.ceil(o/n/h),d=Math.ceil(l/i/h),m+=c*d;h=s**e,c=Math.ceil(o/n/h),d=Math.ceil(l/i/h),m+=t*c+r,m*=4*f;const y=this._storageIndex.subarray(m,m+4*f);let g=0,x=0;const v=[];for(let I=0;I<f;I++)g=y[4*I+0]*2**32+y[4*I+1],x=g+y[4*I+2]*2**32+y[4*I+3],v.push({from:g,to:x});return{ranges:v,actualTileWidth:r<c-1?n:Math.ceil(o/h)-n*(c-1),actualTileHeight:t<d-1?i:Math.ceil(l/h)-i*(d-1)}}_parseHeader(e){const t=Ie(e,"MRF_META/Raster");if(!t)throw new o.Z("mrf:open","not a valid MRF format");const r=Ie(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),s=parseInt(r.getAttribute("c"),10),a=(be(t,"Compression")||"none").toLowerCase();if(!a||-1===["none","lerc"].indexOf(a))throw new o.Z("mrf:open","currently does not support compression "+a);const l=be(t,"DataType")||"UInt8",u=Le.get(l);if(null==u)throw new o.Z("mrf:open","currently does not support pixel type "+l);const f=Ie(t,"PageSize"),c=parseInt(f.getAttribute("x"),10),d=parseInt(f.getAttribute("y"),10),p=Ie(t,"DataValues");let m,h;if(p&&(h=p.getAttribute("NoData"),null!=h&&(m=h.trim().split(" ").map(e=>parseFloat(e)))),Ie(e,"MRF_META/CachedSource"))throw new o.Z("mrf:open","currently does not support MRF referencing other data files");const y=Ie(e,"MRF_META/GeoTags"),g=Ie(y,"BoundingBox");if(null==g)throw new o.Z("mrf:open","missing node MRF_META/GeoTags/BoundingBox");const x=parseFloat(g.getAttribute("minx")),v=parseFloat(g.getAttribute("miny")),I=parseFloat(g.getAttribute("maxx")),b=parseFloat(g.getAttribute("maxy")),w=be(y,"Projection")||"",C=be(e,"datafile"),_=be(e,"IndexFile");let T;if("LOCAL_CS[]"!==w)if(w.toLowerCase().startsWith("epsg:")){const e=Number(w.slice(5));isNaN(e)||0===e||(T=new O.Z({wkid:e}))}else T=Re(w);const S=new F.Z(x,v,I,b);S.spatialReference=T;const R=Ie(e,"MRF_META/Rsets"),k=parseInt(R&&R.getAttribute("scale")||"2",10),P=new J.Z({origin:new $.Z({x:S.xmin,y:S.ymax,spatialReference:T}),blockWidth:c,blockHeight:d,pyramidBlockWidth:c,pyramidBlockHeight:d,compression:a,pyramidScalingFactor:k}),M=new $.Z({x:(I-x)/n,y:(b-v)/i,spatialReference:T});return{rasterInfo:new L.Z({width:n,height:i,extent:S,spatialReference:T,bandCount:s,pixelType:u,pixelSize:M,noDataValue:m,storageInfo:P}),files:{mrf:this.url,index:_||this.url.replace(".mrf",".idx"),data:C||this.url.replace(".mrf",Je.get(a))}}}_fetchAuxiliaryData(e){var t=this;return(0,n.Z)(function*(){try{const{data:r}=yield t.request(t.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return Pe(r)}catch{return null}})()}};(0,i._)([(0,c.Cb)()],We.prototype,"_files",void 0),(0,i._)([(0,c.Cb)()],We.prototype,"_storageIndex",void 0),(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],We.prototype,"datasetFormat",void 0),We=(0,i._)([(0,y.j)("esri.layers.support.rasterIO.MRFRaster")],We);var qe=We,je=r(5880),Ue=r(57070);const Ge=function(e,t){const r=e.get(t);return r&&r.values},Ve=function(e,t){const r=e.get(t);return r&&r.values[0]};let $e=class extends X{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}open(e){var t=this;return(0,n.Z)(function*(){var r,n,i;yield t.init();const s=e?(0,l.Wg)(e.signal):null,{data:a}=yield t.request(t.url,{range:{from:0,to:t._bufferSize},responseType:"array-buffer",signal:s});if(!a)throw new o.Z("tiffraster:open","failed to open url "+t.url);t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const{littleEndian:u,firstIFD:f,isBigTiff:c}=(0,je.p)(a),d=[];yield t.readIFDs(d,a,u,f,0,c?8:4,s);const p=(0,je.g)(d),{width:m,height:h,tileWidth:y,tileHeight:g,planes:x,pixelType:v,compression:I,firstPyramidLevel:b,maximumPyramidLevel:w,pyramidBlockWidth:C,pyramidBlockHeight:_,tileBoundary:T,affine:S,metadata:R}=p;let k=Re((null==(r=p.extent.spatialReference)?void 0:r.wkt)||(null==(n=p.extent.spatialReference)?void 0:n.wkid)),P=!1;null==k&&(P=!0,k=new O.Z({wkid:3857}));const M=new F.Z({...p.extent,spatialReference:k}),Z=new $.Z(M?{x:M.xmin,y:M.ymax,spatialReference:k}:{x:0,y:0}),D=new J.Z({blockWidth:y,blockHeight:g,pyramidBlockWidth:C,pyramidBlockHeight:_,compression:I,origin:Z,firstPyramidLevel:b,maximumPyramidLevel:w,blockBoundary:T}),B=new $.Z({x:(M.xmax-M.xmin)/m,y:(M.ymax-M.ymin)/h,spatialReference:k}),z=new L.Z({width:m,height:h,bandCount:x,pixelType:v,compression:I,pixelSize:B,storageInfo:D,spatialReference:k,isPseudoSpatialReference:P,keyProperties:R?{BandProperties:R.bandProperties,DataType:R.dataType}:{},extent:M,statistics:R?R.statistics:null});if(null!=S&&S.length&&(z.nativeExtent=new F.Z({xmin:-.5,ymin:.5-h,xmax:m-.5,ymax:.5,spatialReference:k}),z.transform=new ue({polynomialOrder:1,forwardCoefficients:[S[2]+S[0]/2,S[5]-S[3]/2,S[0],S[3],-S[1],-S[4]]}),z.extent=z.transform.forwardTransform(z.nativeExtent),z.pixelSize=new $.Z({x:(M.xmax-M.xmin)/m,y:(M.ymax-M.ymin)/h,spatialReference:k}),D.origin.x=-.5,D.origin.y=.5),null==(i=t.ioConfig.skipExtensions)||!i.includes("aux.xml")){const r=yield t._fetchAuxiliaryData(e);if(null!=r){var E;if(z.statistics=null!=(E=r.statistics)?E:z.statistics,z.histograms=r.histograms,r.histograms&&!(0,l.pC)(z.statistics)&&(z.statistics=(0,G.Oh)(r.histograms)),r.transform&&!S){z.transform=r.transform,z.nativeExtent=z.extent;const e=z.transform.forwardTransform(z.nativeExtent);z.pixelSize=new $.Z({x:(e.xmax-e.xmin)/m,y:(e.ymax-e.ymin)/h,spatialReference:k}),z.extent=e}z.spatialReference||(z.spatialReference=r.spatialReference)}}if(t._set("rasterInfo",z),t._headerInfo={littleEndian:u,isBigTiff:c,ifds:d,...p},!t._headerInfo.isSupported)throw new o.Z("tiffraster:open","this tiff is not supported: "+t._headerInfo.message);t.updateTileInfo()})()}fetchRawTile(e,t,r,i={}){var s=this;return(0,n.Z)(function*(){var n;if(null==(n=s._headerInfo)||!n.isSupported||s.isBlockOutside(e,t,r))return null;const a=s.getTileLocation(e,t,r);if(!a)return null;const{ranges:o,actualTileWidth:l,actualTileHeight:u,ifd:f}=a,c=o.map(e=>s.request(s.url,{range:e,responseType:"array-buffer",signal:i.signal})),d=yield Promise.all(c),p=d.map(e=>e.data.byteLength).reduce((e,t)=>e+t),m=1===d.length?d[0].data:new ArrayBuffer(p),h=[0],y=[0];if(d.length>1){const e=new Uint8Array(m);for(let t=0,r=0;t<d.length;t++){const n=d[t].data;e.set(new Uint8Array(n),r),h[t]=r,r+=n.byteLength,y[t]=n.byteLength}}const{blockWidth:g,blockHeight:x}=s.getBlockWidthHeight(e),v=yield s.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:s._headerInfo,ifd:f,offsets:h,sizes:y},width:g,height:x,planes:null,pixelType:null});let I,b,w;if(l!==g||u!==x){let e=v.mask;if(e)for(I=0;I<x;I++)if(w=I*g,I<u)for(b=l;b<g;b++)e[w+b]=0;else for(b=0;b<g;b++)e[w+b]=0;else for(e=new Uint8Array(g*x),v.mask=e,I=0;I<u;I++)for(w=I*g,b=0;b<l;b++)e[w+b]=1}return v})()}readIFDs(e,t,r,i,s,a=4,o){var l=this;return(0,n.Z)(function*(){if(!i)return null;(i>=t.byteLength||i<0)&&(t=(yield l.request(l.url,{range:{from:i+s,to:i+s+l._bufferSize},responseType:"array-buffer",signal:o})).data,s=i+s,i=0);const n=yield l.readIFD(t,r,i,s,Ue.Z.TIFF_TAGS,a,o);if(e.push(n.ifd),!n.nextIFD)return null;yield l.readIFDs(e,t,r,n.nextIFD-s,s,a,o)})()}readIFD(e,t,r,i,s=Ue.Z.TIFF_TAGS,a=4,o){var l=this;return(0,n.Z)(function*(){if(!e)return null;const n=(0,je.b)(e,t,r,i,s,a);if(n.success){const r=[];if(n.ifd.forEach(e=>{e.values||r.push(e)}),r.length>0){const n=r.map(e=>e.offlineOffsetSize),s=Math.min.apply(null,n.map(e=>e[0]));if(Math.min.apply(null,n.map(e=>e[0]+e[1]))-s<=l._bufferSize){const{data:n}=yield l.request(l.url,{range:{from:s,to:s+l._bufferSize},responseType:"array-buffer",signal:o});e=n,i=s,r.forEach(r=>(0,je.c)(e,t,r,i))}}if(n.ifd.has("GEOKEYDIRECTORY")){const r=n.ifd.get("GEOKEYDIRECTORY"),s=r.values;if(s&&s.length>4){const n=s[0]+"."+s[1]+"."+s[2],a=yield l.readIFD(e,t,r.valueOffset+6-i,i,Ue.Z.GEO_KEYS,2,o);r.data=a.ifd,r.data&&r.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[n]})}}return n}if(n.requiredBufferSize&&n.requiredBufferSize!==e.byteLength){const r=yield l.request(l.url,{range:{from:i,to:i+n.requiredBufferSize+4},responseType:"array-buffer",signal:o});return(e=r.data).byteLength<n.requiredBufferSize?null:l.readIFD(e,t,0,i,Ue.Z.TIFF_TAGS,4,o)}})()}getTileLocation(e,t,r){const{firstPyramidLevel:n,blockBoundary:i}=this.rasterInfo.storageInfo,s=0===e?0:e-(n-1),a=this._headerInfo.ifds[s];if(!a)return null;const o=(0,je.i)(a,this._headerInfo),l=Ge(a,"TILEOFFSETS");if(void 0===l)return null;const u=Ge(a,"TILEBYTECOUNTS"),{minRow:f,minCol:c,maxRow:d,maxCol:p}=i[s];if(t>d||r>p||t<f||r<c)return null;const m=Ve(a,"IMAGEWIDTH"),h=Ve(a,"IMAGELENGTH"),y=Ve(a,"TILEWIDTH"),g=Ve(a,"TILELENGTH"),x=o?this.rasterInfo.bandCount:1,v=x*t*(p+1)+r,I=[{from:l[v],to:l[v+x-1]+u[v+x-1]-1}];if(o){let e=!0;for(let t=0;t<x;t++)if(l[v+t]+u[v+t]!==l[v+t+1]){e=!1;break}if(!e)for(let t=0;t<x;t++)I[t]={from:l[v+t],to:l[v+t]+u[v+t]-1}}return null==l[v]||null==u[v]?null:{ranges:I,ifd:a,actualTileWidth:r===p?m%y:y,actualTileHeight:t===d?h%g:g}}_fetchAuxiliaryData(e){var t=this;return(0,n.Z)(function*(){try{const{data:r}=yield t.request(t.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return Pe(r)}catch{return null}})()}};(0,i._)([(0,c.Cb)()],$e.prototype,"_files",void 0),(0,i._)([(0,c.Cb)()],$e.prototype,"_headerInfo",void 0),(0,i._)([(0,c.Cb)()],$e.prototype,"_bufferSize",void 0),(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],$e.prototype,"datasetFormat",void 0),$e=(0,i._)([(0,y.j)("esri.layers.support.rasterDatasets.TIFFRaster")],$e);var Ye=$e;const Xe=new Map;Xe.set("CRF",{desc:"Cloud Raster Format",constructor:ye}),Xe.set("MRF",{desc:"Meta Raster Format",constructor:qe}),Xe.set("TIFF",{desc:"GeoTIFF",constructor:Ye}),Xe.set("RasterTileServer",{desc:"Raster Tile Server",constructor:Ne}),Xe.set("JPG",{desc:"JPG Raster Format",constructor:Fe}),Xe.set("PNG",{desc:"PNG Raster Format",constructor:Fe}),Xe.set("GIF",{desc:"GIF Raster Format",constructor:Fe}),Xe.set("BMP",{desc:"BMP Raster Format",constructor:Fe});var Ke=r(524);let Qe=class extends((0,x.h)((0,N.M)((0,B.q)((0,z.I)((0,v.N)(D((0,E.Q)((0,u.R)(g.Z))))))))){constructor(...e){super(...e),this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.title=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=(0,l.pC)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(f.r9).then(()=>this._openRaster(t))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){var e,t;let r=[new H.Z({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})];const n=null==(e=this.rasterInfo)||null==(t=e.attributeTable)?void 0:t.fields;if(n){const e=n.filter(e=>"oid"!==e.type&&"value"!==e.name.toLowerCase()).map(e=>{const t=e.clone();return t.name="Raster."+e.name,t});r=r.concat(e)}const i=this.rasterInfo.dataType;if(("vector-magdir"===i||"vector-uv"===i)&&(0,l.pC)(this.rasterInfo.multidimensionalInfo)){var s;const e=null==(s=this.rasterInfo.multidimensionalInfo.variables[0].unit)?void 0:s.trim();r.push(new H.Z({name:"Raster.Magnitude",alias:"Magnitude"+(e?` (${e})`:""),domain:null,editable:!1,type:"double"})),r.push(new H.Z({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return r}set renderer(e){this._set("renderer",e),this.updateRenderer()}readRenderer(e,t,r){const n=(0,a.ij)(t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,r)||void 0;if(null!=n)return n}createPopupTemplate(e){return(0,Ke.eZ)({fields:this.rasterFields,title:this.title},e)}write(e,t){const{raster:r}=this;return(this.loaded?"RasterTileServer"===r.datasetFormat&&("Raster"===r.tileType||"Map"===r.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))?super.write(e,t):(t&&t.messages&&t.messages.push(new o.Z("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${t.origin}/${t.layerContainerType||"operational-layers"}'`,{layer:this})),null)}_openRaster(e){var t=this;return(0,n.Z)(function*(){t.raster?(t.raster.rasterInfo||(yield t.raster.open()),t.url=t.raster.url):t.raster=yield class{static get supportedFormats(){const e=new Set;return Xe.forEach((t,r)=>e.add(r)),e}static open(e){var t=this;return(0,n.Z)(function*(){const{url:r,ioConfig:n,sourceJSON:i}=e;let s=e.datasetFormat;null==s&&r.lastIndexOf(".")&&(s=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===s||"TIF"===s?s="TIFF":"JPG"!==s&&"JPEG"!==s&&"JFIF"!==s||(s="JPG"),r.toLowerCase().indexOf("/imageserver")>-1&&-1===r.toLowerCase().indexOf("/wcsserver")&&(s="RasterTileServer");const a={url:r,sourceJSON:i,datasetFormat:s,ioConfig:n||{bandIds:null,sampling:null}};let l,u;if(t.supportedFormats.has(s))return l=Xe.get(s).constructor,u=new l(a),yield u.open({signal:e.signal}),u;if(s)throw new o.Z("rasterfactory:open","not a supported format "+s);const f=Array.from(Xe.keys());let c=0;const d=function(){return s=f[c++],s?(l=Xe.get(s).constructor,u=new l(a),u.open({signal:e.signal}).then(()=>u).catch(()=>d())):null};return d()})()}static register(e,t,r){Xe.has(e.toUpperCase())||Xe.set(e.toUpperCase(),{desc:t,constructor:r})}}.open({url:t.url,sourceJSON:t.sourceJSON,ioConfig:{sampling:"closest",...t.ioConfig,customFetchParameters:t.customParameters},signal:e});const{rasterInfo:r}=t.raster;if(!r)throw new o.Z("imagery-tile-layer:load","cannot load resources on "+t.url);t.sourceJSON=t.sourceJSON||t.raster.sourceJSON,null!=t.sourceJSON&&(t._set("version",t.sourceJSON.currentVersion),t._set("copyright",t.sourceJSON.copyrightText)),null==t.title&&(t.title=t.raster.datasetName),"Map"===t.raster.tileType&&(t.popupEnabled=!1),t._configDefaultSettings(),t.watch("customParameters",e=>t.raster.ioConfig.customFetchParameters=e)})()}};(0,i._)([(0,c.Cb)({type:[d.z8],json:{write:{overridePolicy(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null==(e=this.bandIds)?void 0:e.join(","))}}}}})],Qe.prototype,"bandIds",void 0),(0,i._)([(0,c.Cb)({json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,m.J)(A.c)],Qe.prototype,"interpolation",void 0),(0,i._)([(0,c.Cb)({json:{write:!0}})],Qe.prototype,"multidimensionalDefinition",void 0),(0,i._)([(0,c.Cb)(_.rn)],Qe.prototype,"legendEnabled",void 0),(0,i._)([(0,c.Cb)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],Qe.prototype,"isReference",void 0),(0,i._)([(0,c.Cb)({type:["show","hide"]})],Qe.prototype,"listMode",void 0),(0,i._)([(0,c.Cb)()],Qe.prototype,"sourceJSON",void 0),(0,i._)([(0,c.Cb)({readOnly:!0})],Qe.prototype,"version",void 0),(0,i._)([(0,c.Cb)()],Qe.prototype,"title",void 0),(0,i._)([(0,c.Cb)({readOnly:!0,json:{read:!1}})],Qe.prototype,"type",void 0),(0,i._)([(0,c.Cb)({type:["ArcGISTiledImageServiceLayer"]})],Qe.prototype,"operationalLayerType",void 0),(0,i._)([(0,c.Cb)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(e,t,r){t[r]=!e}}}})],Qe.prototype,"popupEnabled",void 0),(0,i._)([(0,c.Cb)({type:s.Z,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],Qe.prototype,"popupTemplate",void 0),(0,i._)([(0,c.Cb)({readOnly:!0})],Qe.prototype,"defaultPopupTemplate",null),(0,i._)([(0,c.Cb)({readOnly:!0,type:[H.Z]})],Qe.prototype,"fields",void 0),(0,i._)([(0,c.Cb)({readOnly:!0,type:[H.Z]})],Qe.prototype,"rasterFields",null),(0,i._)([(0,c.Cb)({types:a.dr,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){var e;const t="raster-stretch"===(null==(e=this.renderer)?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:a.FK,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type})}}}}})],Qe.prototype,"renderer",null),(0,i._)([(0,h.r)("renderer")],Qe.prototype,"readRenderer",null),Qe=(0,i._)([(0,y.j)("esri.layers.ImageryTileLayer")],Qe);var et=Qe}}]);